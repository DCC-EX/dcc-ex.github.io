

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Motor Board Configuration &mdash; DCC++ EX  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/dccex_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/js/platform.js"></script>
        <script src="../_static/js/extra.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Startup Configuration" href="startup-config.html" />
    <link rel="prev" title="WiFi Configuration" href="wifi-config.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
          

          
            <a href="../index.html">
          

          
            
            <img src="../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../get-started/index.html">Get Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../get-started/levels.html">Choose Your Level</a></li>
<li class="toctree-l2"><a class="reference internal" href="../get-started/assembly.html">Assembling the Command Station</a></li>
<li class="toctree-l2"><a class="reference internal" href="../get-started/wifi-setup.html">Adding a WiFi Option</a></li>
<li class="toctree-l2"><a class="reference internal" href="../get-started/installer.html">Install using the Automated Installer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../get-started/arduino-ide.html">Install using the Arduino IDE</a></li>
<li class="toctree-l2"><a class="reference internal" href="../get-started/controllers.html">Choosing a Controller (Throttle)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../get-started/diagnosing-issues.html">Diagnosing Issues (Troubleshooting)</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Advanced Setup</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="wifi-config.html">WiFi Configuration</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Motor Board Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="startup-config.html">Startup Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="supported-motorboards/index.html">Supported Motorboards Setup Notes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="supported-motorboards/L298N-motor-board-setup.html">L298N Motor Board Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="supported-motorboards/IBT_2-motor-board-setup.html">IBT_2 BTS7960 Motor Board</a></li>
<li class="toctree-l3"><a class="reference internal" href="supported-motorboards/IRF3205-motor-board-setup.html">IRF3205 Motor Board Setup</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="supported-microcontrollers/index.html">Supported Microcontrollers Setup Notes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="supported-microcontrollers/wifi-mega.html">Mega+WiFi Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="supported-microcontrollers/nano.html">Arduino Nano Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="supported-microcontrollers/nano-every.html">Nano Every</a></li>
<li class="toctree-l3"><a class="reference internal" href="supported-microcontrollers/teensy.html">Teensy</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="high-accuracy.html">High Accuracy Waveform Mode</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../throttles/index.html">Throttles</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../throttles/protocols.html">WiThrottle Server, Web Server, DCC++ API Explained</a></li>
<li class="toctree-l2"><a class="reference internal" href="../throttles/ex-webthrottle.html">DCC++ EX Web Throttle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../throttles/engine-driver.html">Engine Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../throttles/withrottle.html">WiThrottle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../throttles/dccpp-cab.html">DCCpp CAB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../throttles/locontrol.html">Locontrol</a></li>
<li class="toctree-l2"><a class="reference internal" href="../throttles/cab-engineer.html">Cab Engineer: DCC Throttle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../throttles/digitrainspro.html">DigiTrainsPro</a></li>
<li class="toctree-l2"><a class="reference internal" href="../throttles/srcpclient.html">SRCP Client for iOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../throttles/streamdeck.html">Elgato Stream Deck</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../automation/index.html">Automation (EX-RAIL)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../automation/EX-RAIL-intro.html">Introduction to EX-RAIL Automation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../automation/EX-RAIL-summary.html">EX-RAIL Command Summary</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/hardware/index.html">Hardware</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../reference/hardware/microcontroller-boards.html">Microcontroller Boards</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/hardware/motor-boards.html">Motor Boards</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/hardware/wifi-boards.html">WiFi Boards</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/hardware/ethernet-boards.html">Ethernet Boards</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/hardware/i2c-displays.html">I2C Displays</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/hardware/i2c-devices.html">I2C Devices</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/hardware/gpio-module.html">I2C GPIO Expander Modules</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/hardware/servo-module.html">Connecting a Servo Module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/hardware/power-supplies.html">Power Supplies</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/hardware/accessory-controllers.html">Accessory Controllers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/hardware/shopping-list.html">Shopping List</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../reference/software/hal-config.html">I/O Device Drivers and HAL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/software/hal.html">DCC++EX HAL Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/software/writing-hal-driver.html">Writing a HAL Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/software/release-notes.html">Release Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/software/command-reference.html">DCC++ EX Command Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/software/command-summary.html">DCC++ EX Command Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/software/diagnostic-d-ack-command.html">Diagnostics <code class="docutils literal notranslate"><span class="pre">&lt;D</span> <span class="pre">ACK&gt;</span></code> Command</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/software/diagnostic-d-command.html">Diagnostics <code class="docutils literal notranslate"><span class="pre">&lt;D&gt;</span></code> Command</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/accessories/suppliers.html">Hardware, Software, and Accessory Suppliers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/downloads/index.html">Downloads</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../reference/downloads/documents.html">Documents</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/downloads/schematics.html">Schematics</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../reference/tools/index.html">Diagnostic Tools</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../reference/tools/diagnostic-tools.html">DCC Diagnostic Tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/tools/serial-monitor.html">Using a Serial Monitor</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../reference/wire-gauge.html">Wire Gauge Information</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../download/index.html">Software Downloads</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../download/commandstation.html">Command Station Downloads</a></li>
<li class="toctree-l2"><a class="reference internal" href="../download/esp8266.html">ESP8266 Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../download/dcc-inspector-ex.html">DCC Inspector-EX</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../projects/index.html">Projects</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../projects/railsnail-bluetooth.html">RailSnail’s Complete Bluetooth DCC++EX Command Station</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/index.html">Contributing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../contributing/requirements.html">Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing/website.html">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing/development.html">Development</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing/contactus.html">Contact us</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../roadmap/index.html">DCC-EX Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../support/index.html">Support</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../support/create-ticket.html">Submit a Support Ticket</a></li>
<li class="toctree-l2"><a class="reference internal" href="../support/test.html">Form Testing - NOT FOR Support</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../site-map/index.html">Site Map</a></li>
<li class="toctree-l1"><a class="reference internal" href="../donate/index.html">Donate to Our Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../press/index.html">Press</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../press/v40-announce.html">DCC++EX 4.0 Release Announcement</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../about/index.html">About</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../about/about.html">About Us - Meet the Team</a></li>
<li class="toctree-l2"><a class="reference internal" href="../about/rewrite.html">What’s New in DCC++ EX?</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">DCC++ EX</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Advanced Setup</a> &raquo;</li>
        
      <li>Motor Board Configuration</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
              <a href="https://github.com/DCC-EX/dcc-ex.github.io/blob/sphinx/docs/advanced-setup/motor-board-config.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="motor-board-configuration">
<h1>Motor Board Configuration<a class="headerlink" href="#motor-board-configuration" title="Permalink to this headline">¶</a></h1>
<a class="reference internal image-reference" href="../_images/tinkerer.png"><img alt="Tinkerer Icon" class="align-left" src="../_images/tinkerer.png" style="width: 60.0px; height: 49.0px;" /></a>
<p>Tinkerer to Engineer Level</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>DCC++ EX supports many different motor boards, you can select any of the pre-configured boards simply by choosing them from the motor board dropdown list in the installer, or by adding them with one line in your config.h file. If your board is not supported, these instructions will show you how to add it.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>DCC-EX does NOT require the transistor mixer/inverter circuit seen in many tutorials for boards like the L298N and IBT_2 that have separate PWM inputs, use two GPIO pins on the Arduino and connect directly to these boards. However, if you already have that circuit or want to use it in order to use one pin, you may. This will also allow you to use “high accuracy waveform” mode if you need it. See below for more information on high accuracy mode.</p>
</div>
<p><strong>Links in This Page</strong></p>
<ul class="simple">
<li><p><a class="reference internal" href="#configure-using-the-installer"><span class="std std-ref">Configure Using the Installer</span></a></p></li>
<li><p><a class="reference internal" href="#configure-by-editing-the-config-h-file"><span class="std std-ref">Configure By Editing the config.h File</span></a></p></li>
<li><p><a class="reference internal" href="#your-board-is-in-the-supported-list"><span class="std std-ref">Your Board is in the Supported List</span></a></p></li>
<li><p><a class="reference internal" href="#your-board-is-not-in-the-supported-list"><span class="std std-ref">Your board is NOT in the Supported List</span></a></p></li>
<li><p><a class="reference internal" href="#using-high-accuracy-waveform-mode"><span class="std std-ref">Using High Accuracy Waveform Mode</span></a></p></li>
<li><p><a class="reference internal" href="#current-sense-and-sense-factor"><span class="std std-ref">Current Sense and Sense factor</span></a></p></li>
<li><p><a class="reference internal" href="#just-buy-a-current-sense-board-instead"><span class="std std-ref">Just Buy a Current Sense Board Instead</span></a></p></li>
</ul>
<div class="section" id="configure-using-the-installer">
<h2>Configure Using the Installer<a class="headerlink" href="#configure-using-the-installer" title="Permalink to this headline">¶</a></h2>
<p>Tinkerers and even Conductors should be comfortable with this option. If you are using the installer, just select your board from the motor board drop down list. Make sure your other selections are correct, and then simply upload the changes to your Command Station.</p>
</div>
<div class="section" id="configure-by-editing-the-config-h-file">
<h2>Configure By Editing the config.h File<a class="headerlink" href="#configure-by-editing-the-config-h-file" title="Permalink to this headline">¶</a></h2>
<p>Using the Arduino IDE, PlatformIO, or any other method for editing a file and uploading a sketch, you can add your motor board by editing the config.h file. Click here for a list of <a class="reference internal" href="../reference/hardware/motor-boards.html"><span class="doc">Currently supported boards</span></a></p>
<p>Open the config.h file in your editor. If this is the first time configuring your system, you may need to copy the “config.example.h” file and name the copy “config.h”.</p>
<p>Find this section in the file:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// DEFINE MOTOR_SHIELD_TYPE BELOW ACCORDING TO THE FOLLOWING TABLE:</span>
<span class="c1">//</span>
<span class="c1">//  STANDARD_MOTOR_SHIELD : Arduino Motor shield Rev3 based on the L298 with max 18V 2A per channel</span>
<span class="c1">//  POLOLU_MOTOR_SHIELD   : Pololu MC33926 Motor Driver (not recommended for prog track)</span>
<span class="c1">//  FUNDUMOTO_SHIELD      : Fundumoto Shield, no current sensing (not recommended, no short protection)</span>
<span class="c1">//  FIREBOX_MK1           : The Firebox MK1</span>
<span class="c1">//  FIREBOX_MK1S          : The Firebox MK1S</span>
<span class="c1">//   |</span>
<span class="c1">//   +-----------------------</span>
<span class="c1">//</span>
<span class="cp">#define MOTOR_SHIELD_TYPE STANDARD_MOTOR_SHIELD</span>
</pre></div>
</div>
<p>You will see a list of supported boards with their type and the “STANDARD_MOTOR_SHIELD” defined as the default. Continue below.</p>
<div class="section" id="your-board-is-in-the-supported-list">
<h3>Your Board is in the Supported List<a class="headerlink" href="#your-board-is-in-the-supported-list" title="Permalink to this headline">¶</a></h3>
<p>This option is possibly Conductor friendly for those just choosing a supported board that requires no wiring.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The Arduino Motor Shield, Deek-Robot Motor Shield, DIY More Motor Shield and any other shield or board that is 100% compatible with the Arduino Motor Shield is defined as a “STANDARD_MOTOR_SHIELD”</p>
</div>
<p>To select your board, just change the #define line to the type for your board. The following line configures a Pololu Motor Shield. We just copy and paste its name over the STANDARD_MOTOR_SHIELD:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#define MOTOR_SHIELD_TYPE POLOLU_MOTOR_SHIELD</span>
</pre></div>
</div>
<p>That’s all you need to do. Make your change and then upload the sketch to your Arduino.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If your board is not a shield that plugs onto your Arduino, then you are going to have to run jumper wires. An IBT_2 High Current Motor Board is an example of such a board. See the section on your board for installation help.</p>
</div>
</div>
<div class="section" id="your-board-is-not-in-the-supported-list">
<h3>Your board is NOT in the Supported List<a class="headerlink" href="#your-board-is-not-in-the-supported-list" title="Permalink to this headline">¶</a></h3>
<p>Tinkerer may be required with this option.</p>
<p>If your board is not in the list (remember many boards are considered a “STANDARD_MOTOR_SHIELD”), you can easily add it. In your config.h file, find the line that looks like this:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#define MOTOR_SHIELD_TYPE STANDARD_MOTOR_SHIELD</span>
</pre></div>
</div>
<p>We are going to replace this with a new motor board definition and select it. Comment out the above line and replace it with something that looks like this:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#define MY_MOTOR_SHIELD F(&quot;MY_MOTOR_SHIELD&quot;),\</span>
<span class="cp">  new MotorDriver(3, 12, UNUSED_PIN, UNUSED_PIN, A0, 2.99, 2000, UNUSED_PIN), \</span>
<span class="cp">  new MotorDriver(11, 13, UNUSED_PIN, UNUSED_PIN, A1, 2.99, 2000, UNUSED_PIN)</span>

<span class="cp">#define MOTOR_SHIELD_TYPE MY_MOTOR_SHIELD</span>
</pre></div>
</div>
<ol class="arabic simple">
<li><p>Replace “MY_MOTOR_SHIELD” in both instances with whatever name you like or just leave it as MY_MOTOR_SHIELD.</p></li>
<li><p>The first “new MotorDriver()” line defines your MAIN track, the second one is for your Programming track.</p></li>
<li><p>The format of the MotorDriver code is:</p></li>
</ol>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>MotorDriver(power_pin, signal_pin, signal_pin2, brake_pin, current_pin, senseFactor, tripMilliamps, faultPin)
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Enter the appropriate pin numbers on the Arduino you will connect to your motor board.</p></li>
</ol>
<p>Let’s look at the details of how this works, first here are all the configuration options:</p>
<ul class="simple">
<li><p><strong>power_pin</strong> - This goes to the EN (enable pin) of the motor board; it turns power on and off.</p></li>
<li><p><strong>signal_pin</strong> - This is the pin that outputs the DCC signal and goes to the PWM input of the motor board. For boards that combine the signal into one pin, like the Arduino Motor Shield, you just need to enter the pin here and connect it to the single PWM pin on the motor board.</p></li>
<li><p><strong>signal_pin2</strong> - If your motor board has a “left” and “right” or “CW” and “CCW” input, then this is the pin on the Arduino you want to use to output this half of the signal. The other half comes from the signal_pin mentioned above. If not used, it must be left set to “UNUSED_PIN”.</p></li>
<li><p><strong>brake_pin</strong> - If you were going to use the braking feature (for example to use a Railcom cutout), and have NOT cut the trace for this if one exists for your motor board, then you would enter this pin here. If not used, leave it set to “UNUSED_PIN”.</p></li>
<li><p><strong>sense_pin</strong> - This is the analog input pin on the Arduino that will get current sense information from the motor board. The programming track usually connects to A1, and main to A0. Important information about current sense is below.</p></li>
<li><p><strong>tripMilliamps</strong> - This is the value for what current in mA will trip the overcurrent protection.</p></li>
<li><p><strong>senseFactor</strong> - This is the multiplier specific to your board or current sense circuit that converts the raw reading into track current in milliAmps. Important information about current sense is below.</p></li>
<li><p><strong>faultPin</strong> - Some boards can report a fault condition, for example under-voltage or over-heating. If you want this feature, you can specify the Arduino digital pin here, and connect it to the fault output of the motor board.</p></li>
</ul>
<p>As another example let’s create a motor board definition or a board that requires 2 PWM inputs and has the following specifications:</p>
<ul class="simple">
<li><p>Current sense factor of 1 Amp per volt</p></li>
<li><p>Maximum current of 5 Amps</p></li>
<li><p>We will choose pin 9 for our second PWM pin</p></li>
</ul>
<p>senseFactor = ((5/1024)/Board Volts/Amp)*1000 = ((.00488)/(1/1))*1000 = 4.88</p>
<p>The second board will be an Arduino Motor Shield to use for programming. We already have the definition for the Standard Motor Shield, so we will leave the second MotorDriver line alone. Our new definition will look like this:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#define 2_PWM_MOTOR_BOARD F(&quot;2_PWM_MOTOR_BOARD&quot;),\</span>
<span class="cp">  new MotorDriver(3, 12, 9, UNUSED_PIN, A0, 4.88, 5000, UNUSED_PIN), \</span>
<span class="cp">  new MotorDriver(11, 13, UNUSED_PIN, UNUSED_PIN, A1, 2.99, 2000, UNUSED_PIN)</span>

<span class="cp">#define MOTOR_SHIELD_TYPE 2_PWM_MOTOR_BOARD</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="using-high-accuracy-waveform-mode">
<h2>Using High Accuracy Waveform Mode<a class="headerlink" href="#using-high-accuracy-waveform-mode" title="Permalink to this headline">¶</a></h2>
<p>You may ask, “Do I need high accuracy waveforms?” and the answer is probably not. But we are engineers, and we love to spend our days trying to eke out every bit of performance from the system, and maintain bragging rights for thinking of something 5% more clever than the other members of our team! Even our “standard” waveform is within the NMRA specification. For purists, or if you find a particular decoder that is not in spec and needs to have tighter timing on the DCC waveform, you can make sure you are using high accuracy mode.</p>
<p>If you are using the STANDARD_MOTOR_SHIELD configuration on a Mega, high accuracy is on by default. For an Uno, Nano or Pro Mini, you would need to change which pins you use, and use jumpers. Basically, for any track for which you want the higher accuracy, you need to make sure that the signal pin is one of the timer pins on the board. For a Mega, those are pins 11, 12 and 13. For an Uno, they are 9 and 10. For more info on how this works, see <a class="reference internal" href="high-accuracy.html"><span class="doc">High Accuracy Waveform Mode</span></a>.</p>
</div>
<div class="section" id="current-sense-and-sense-factor">
<h2>Current Sense and Sense factor<a class="headerlink" href="#current-sense-and-sense-factor" title="Permalink to this headline">¶</a></h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>It is VERY important to connect some form of current sensing! Without it, you cannot program decoders on the programming track, and you will not have any short circuit protection on either track!</p>
</div>
<p>Current sense is actually a voltage output by the motor board that is proportional to the current being delivered to the track. While you are running trains on your MAIN track, the CS is constantly monitoring the current so that we can shut off power to the track in case of a short circuit. Programs like JMRI have a dashboard that can report how much current you are using in real-time.</p>
<p>The PROG track requires current sense to detect the current pulse back from decoders to ACKnowledge the receipt of your command. The DCC specification says that a decoder must send a short 60mA (60 milliAmps) or more current pulse to the programming track for at least 6ms (6 milliseconds). You may still be able to have the decoder accept a command if current sense is not working, just as you would for POM (programming on main), but you will receive no acknowledgement from the loco, and you will have no way to read CVs.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The DCC-EX team may be able to help you find the correct settings for your board. However, this may still require you to be at our “Engineer Level” to feel comfortable going further in this section.</p>
</div>
<p>In order to calculate the current, we need to know the “Volts per Amp” reported by the motor board current sense circuit. For example, the Arduino Motor Shield, using the L298 dual H-Bridge, has a special circuit that gives us 1.65V/A (1.65 Volts per Amp) reported. In theory, that means this board would send 1.65V to our Arduino analog sense pin when 1A of current was flowing from the motor board. When 2A was flowing, we should see 3.3V on our sense pin.</p>
<p>The Arduino has an ADC (Analog to Digital Converter) that reads this analog voltage, samples it, and converts it to a digital reading. Arduino pins have a 10 bit resolution, which means it can hold a maximum value of 1024, with current expressed as a number from 0 to 1023. Therefore, we need a senseFactor constant to help us convert the raw Arduino pin reading to a relevant current reading in milliAmps. Here is the formula we use to find this constant for a particular motor board:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">senseFactor</span> <span class="o">=</span> <span class="p">((</span><span class="mi">5</span><span class="o">/</span><span class="mi">1024</span><span class="p">)</span><span class="o">/</span><span class="n">Board</span> <span class="n">Volts</span><span class="o">/</span><span class="n">Amp</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span>
</pre></div>
</div>
<p>The Arduino analog pin can go from 0 to 5V, and has 1024 possible levels, so we divide 5 by 1024, then divide by the V/A figure from the motor board current sense output, then multiply it by 1000 to make the number easier to work with. From our example of the Arduino motor shield above and its published 1.65V/A, we can compute the senseFactor as follows:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">senseFactor</span> <span class="o">=</span> <span class="p">((</span><span class="mi">5</span><span class="o">/</span><span class="mi">1024</span><span class="p">)</span><span class="o">/</span><span class="mf">1.65</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span> <span class="o">=</span> <span class="mf">2.96</span>
</pre></div>
</div>
<p>You may notice that we actually use 2.99 in our code. You caught us! Through experimentation and measurement, we tweak these values to be more accurate. Nothing is ever 100% as reported in a data sheet.</p>
<p>We use the senseFactor to calculate our current in milliAmps by just taking a raw pin reading and multiplying it by this current senseFactor. Again using the Arduino Motor Shield values, if we got a reading of 300 (out of a possible value between 0 and 1023), that would be 300 * 2.99 or about 897mA.</p>
<p>You will also note that if you have the maximum of 2A flowing for this board (2000mA), that the pin reading will only be around 669. That isn’t very close to 1023. That is because the Arduino Motor Shield actually only reports its maximum current of 2 Amps as 3.3V, not 5. That would let you use a 3.3V microcontroller with this motor shield.</p>
<p>Many of the stand-alone (discrete) motor boards like the L298N or IBT_2 require a current sense resistor connected between the CS pin on the motor board and ground. This creates a voltage we can read by then connecting the pin to our CS analog pin (usually A0 or A1). This resistor needs to be very small, usually .15 to .25 ohms. We don’t want a large voltage drop taking power away from our track (E = I * R, so 2 Amps at 1 Ohm would drop 2 Volts!). We also don’t want to have to have a huge resistor (P = I * E, so 2V drop in the resistor times 2 Amps of current is 4 Watts!). But, you say, if the Arduino Motor Shield uses only a .15 Ohm resistor, that’s only a voltage reading of 0 to .3 volts (.15 Ohms * 2 Amps). That is a very low reading for the Arduino to read! And that is why the motor shield has an op amp circuit that multiplies this voltage by 11 to bring it up to 3.3 Volts and put it in a range that an Arduino can read.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Choose your current sense resistor or circuit carefully! You need to account for all the factors mentioned above, and you do not want to apply more than 5 Volts to any pin on an Arduino! (Be even more careful if you are using a 3.3V board).</p>
</div>
<div class="section" id="how-do-i-find-volts-per-amp">
<h3>How Do I Find Volts per Amp?<a class="headerlink" href="#how-do-i-find-volts-per-amp" title="Permalink to this headline">¶</a></h3>
<p>In some cases, the datasheet for your motor shield will list it. If the board or chip only provides a raw output, you are going to have to figure it out using Ohm’s law. For a board like the IBT_2 that can handle 30 or more Amps, you are going to have to choose a useful range and design your current sense circuit to handle that range. We recommend using no more than 5 Amps on your main track. If you need more than 5 Amps, you should use separate power districts and separate boosters. Be sure to set your motor board tripCurrent value to 5000, and be sure that the voltage from your motor board sense resistor/circuit does not exceed the Arduino pin input of 5V. For each motor board we test, we provide what you need to know on the page for that device. See the <a class="reference internal" href="index.html"><span class="doc">Advanced Setup Section</span></a> for more info.</p>
</div>
<div class="section" id="just-buy-a-current-sense-board-instead">
<h3>Just Buy a Current Sense Board Instead<a class="headerlink" href="#just-buy-a-current-sense-board-instead" title="Permalink to this headline">¶</a></h3>
<p>Tinkerers and Conductors who don’t mind connecting a few jumper wires may like this option.</p>
<p>This saves a lot of time and hassle (not to mention math), and also brings things into the realm of Tinkerer rather than just an Engineer. You also have the added benefit that the same current sense board can be used with lots of different motor boards. Many of these boards have a very simple current conversion factor because they output 1 Volt for 1 Amp! While discontinued, you can still find MAX471 boards for sale.</p>
</div>
<div class="section" id="where-do-i-measure-the-current">
<h3>Where do I measure the current?<a class="headerlink" href="#where-do-i-measure-the-current" title="Permalink to this headline">¶</a></h3>
<p>Another way to ask the question is, “How do I connect a current sensor?” There are 2 ways to connect a current sensor board, listed here by ease of use:</p>
<ol class="arabic simple">
<li><p>Insert the board in the current path of the Voltage going into the motor board.</p></li>
<li><p>Insert the board in the current path from the output of the board to the track.</p></li>
</ol>
<div class="section" id="reading-the-input-to-the-motor-board">
<h4>Reading the input to the motor board<a class="headerlink" href="#reading-the-input-to-the-motor-board" title="Permalink to this headline">¶</a></h4>
<p>The first option has the advantage of a simple connection, and that it can use a DC (unidirectional) current sensor or a bi-directional current sensor. To connect it, you take the ground lead of the track power supply and connect it to the ground lug of the motor board. Then, instead of connecting the positive wire to the motor board input, you connect it to the positive terminal of the current sensor. You then use another wire to go from the negative terminal of the current sensor to the positive lug of the motor board. By inserting the current sense board in series with power connection, we can measure current.</p>
<p>The disadvantage of measuring at the input power stage is that we are measuring the <em>total current</em> to the board. That means we are measuring the current used by the motor board <em>and</em> your trains. It takes power to run any electronics, so there is current being used by the motor board even without any locos on the track. The good news is that it is a small current and we can account for it. As a matter of fact, on the programming track, DCC++EX does a quick calibration to “zero out” or “tare” the resting current so we have a baseline to measure decoder ACK pulses against.</p>
<p>The other disadvantage is that if your motor board has both MAIN and PROG sections on it, you need to turn off power to the MAIN track when you are going to do any programming (reading and writing CVs) on the PROG track. There is no way of reading the current of each H-Bridge separately without modifying a dual H-Bridge board like this.</p>
</div>
<div class="section" id="reading-the-output-to-the-track">
<h4>Reading the output to the track<a class="headerlink" href="#reading-the-output-to-the-track" title="Permalink to this headline">¶</a></h4>
<p>This method has the advantage of reading the actual current being used by things attached to the track, i.e. trains. It has the further advantage of being able to read MAIN current and PROG current separately, even on boards that have both H-Bridges on the same board. That makes sense, because you are, in effect, connecting to the track circuit, not the motor board.</p>
<p>The disadvantage is that you MUST use a bi-directional current sensor, and you need 2 sensors if you want to use one to sense ACKs (acknowledgements) from locos on the programming track, and to sense current and detect an overload (short circuit) on either track.</p>
<p>No matter which method you choose, you are going to have to either select the correct motor board type in your config.h file, or create a motorboard definition to tell DCC++EX which pins you are connecting your current sense board(s) to, and what current sense factor to use to report the current accurately.</p>
<p>For details and instructions on how to connect and configure non-Arduino Motor Shield boards and their clones, see the <a class="reference internal" href="supported-motorboards/index.html"><span class="doc">Supported Motorboards Setup Notes</span></a>.</p>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="startup-config.html" class="btn btn-neutral float-right" title="Startup Configuration" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="wifi-config.html" class="btn btn-neutral float-left" title="WiFi Configuration" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020-2022 - Fred Decker, Mani Kumar.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>