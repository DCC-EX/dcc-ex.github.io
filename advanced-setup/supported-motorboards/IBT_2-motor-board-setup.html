

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>IBT_2 BTS7960 Motor Board &mdash; DCC++ EX  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/dccex_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/js/platform.js"></script>
        <script src="../../_static/js/extra.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="IRF3205 Motor Board Setup" href="IRF3205-motor-board-setup.html" />
    <link rel="prev" title="L298N Motor Board Setup" href="L298N-motor-board-setup.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../get-started/index.html">Get Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../get-started/levels.html">Levels</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../get-started/assembly.html">Assembly</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../get-started/wifi-setup.html">WiFi Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../get-started/installer.html">Install using the Automated Installer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../get-started/arduino-ide.html">Install using the Arduino IDE</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../get-started/controllers.html">Choosing a Controller (Throttle)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../get-started/diagnosing-issues.html">Diagnosing Issues (Troubleshooting)</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Advanced Setup</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../wifi-config.html">WiFi Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../motor-board-config.html">Motor Board Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../startup-config.html">Startup Configuration</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Supported Motorboards Setup Notes</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="L298N-motor-board-setup.html">L298N Motor Board Setup</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">IBT_2 BTS7960 Motor Board</a></li>
<li class="toctree-l3"><a class="reference internal" href="IRF3205-motor-board-setup.html">IRF3205 Motor Board Setup</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../supported-microcontrollers/index.html">Supported Microcontrollers Setup Notes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../supported-microcontrollers/wifi-mega.html">Mega+WiFi Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../supported-microcontrollers/nano.html">Arduino Nano Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="../supported-microcontrollers/nano-every.html">Nano Every</a></li>
<li class="toctree-l3"><a class="reference internal" href="../supported-microcontrollers/teensy.html">Teensy</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../high-accuracy.html">High Accuracy Waveform Mode</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../throttles/index.html">Throttles</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../throttles/protocols.html">WiThrottle Server, Web Server, DCC++ API Explained</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../throttles/ex-webthrottle.html">DCC++ EX Web Throttle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../throttles/engine-driver.html">Engine Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../throttles/withrottle.html">WiThrottle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../throttles/dccpp-cab.html">DCCpp CAB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../throttles/locontrol.html">Locontrol</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../throttles/cab-engineer.html">Cab Engineer: DCC Throttle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../throttles/digitrainspro.html">DigiTrainsPro</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../throttles/srcpclient.html">SRCP Client for iOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../throttles/streamdeck.html">Elgato Stream Deck</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../automation/index.html">Automation (EX-RAIL) BETA!</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../automation/EX-RAIL-intro.html">Introduction to EX-RAIL Automation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../automation/EX-RAIL-ref.html">EX-RAIL Reference</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../reference/hardware/index.html">Hardware</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../reference/hardware/microcontroller-boards.html">Microcontroller Boards</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/hardware/motor-boards.html">Motor Boards</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/hardware/wifi-boards.html">WiFi Boards</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/hardware/ethernet-boards.html">Ethernet Boards</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/hardware/i2c-displays.html">I2C Displays</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/hardware/i2c-devices.html">I2C Devices</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/hardware/gpio-module.html">I2C GPIO Modules</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/hardware/power-supplies.html">Power Supplies</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/hardware/shopping-list.html">Shopping List</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/software/hal-config.html">I/O Device Drivers and HAL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/software/hal.html">DCC++EX HAL Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/software/release-notes.html">Release Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/software/command-reference.html">DCC++ EX Command Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/software/command-summary.html">DCC++ EX Command Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/software/diagnostic-d-ack-command.html">Diagnostics <code class="docutils literal notranslate"><span class="pre">&lt;D</span> <span class="pre">ACK&gt;</span></code> Command</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/software/diagnostic-d-command.html">Diagnostics <code class="docutils literal notranslate"><span class="pre">&lt;D&gt;</span></code> Command</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/accessories/suppliers.html">Hardware, Software, and Accessory Suppliers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/downloads/index.html">Downloads</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../reference/downloads/documents.html">Documents</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/downloads/schematics.html">Schematics</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/tools/index.html">Diagnostic Tools</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../reference/tools/diagnostic-tools.html">DCC Diagnostic Tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/tools/serial-monitor.html">Using a Serial Monitor</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/wire-gauge.html">Wire Gauge Information</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../download/index.html">Software Downloads</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../download/commandstation.html">Command Station Downloads</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../download/esp8266.html">ESP8266 Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../download/dcc-inspector-ex.html">DCC Inspector-EX</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../projects/index.html">Projects</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../projects/railsnail-bluetooth.html">RailSnail’s Complete Blutooth DCC++EX Command Station</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/index.html">Contributing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../contributing/requirements.html">Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../contributing/website.html">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../contributing/development.html">Development</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../contributing/contactus.html">Contact us</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../roadmap/index.html">DCC-EX Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../support/index.html">Support</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../support/create-ticket.html">Submit a Support Ticket</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../about/index.html">About</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../about/rewrite.html">What’s New in DCC++ EX?</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">DCC++ EX</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Advanced Setup</a> &raquo;</li>
        
          <li><a href="index.html">Supported Motorboards Setup Notes</a> &raquo;</li>
        
      <li>IBT_2 BTS7960 Motor Board</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/advanced-setup/supported-motorboards/IBT_2-motor-board-setup.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="ibt-2-bts7960-motor-board">
<h1>IBT_2 BTS7960 Motor Board<a class="headerlink" href="#ibt-2-bts7960-motor-board" title="Permalink to this headline">¶</a></h1>
<a class="reference internal image-reference" href="../../_images/engineer.png"><img alt="Engineer Icon" class="align-left" src="../../_images/engineer.png" style="width: 60.0px; height: 46.5px;" /></a>
<p>Engineer Level</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li><p><a class="reference internal" href="#what-you-will-need-ibt-2"><span class="std std-ref">What You Will Need (IBT_2)</span></a></p></li>
<li><p><a class="reference internal" href="#which-option-should-you-choose-ibt-2"><span class="std std-ref">Which Option Should You Choose? (IBT_2)</span></a></p></li>
<li><p><a class="reference internal" href="#upgrading-use-the-arduino-motor-shield-and-the-ibt-2"><span class="std std-ref">Upgrading (Use the Arduino Motor Shield AND the IBT_2)</span></a></p></li>
<li><p><a class="reference internal" href="#replacing-using-one-ibt-2-for-main-and-another-for-prog"><span class="std std-ref">Replacing (Using One IBT_2 for MAIN and another for PROG)</span></a></p></li>
<li><p><a class="reference internal" href="#important-notes-on-current-sensing-ibt-2"><span class="std std-ref">Important Notes on Current Sensing (IBT_2)</span></a></p></li>
<li><p><a class="reference internal" href="#parts-list-ibt-2"><span class="std std-ref">Parts List (IBT_2)</span></a></p></li>
</ul>
<p>See the <a class="reference internal" href="#parts-list-ibt-2"><span class="std std-ref">Parts List (IBT_2)</span></a></p>
<a class="reference internal image-reference" href="../../_images/ibt_2_bts7960_2.jpg"><img alt="IBT_2 Motor driver" class="align-center" src="../../_images/ibt_2_bts7960_2.jpg" style="width: 225.0px; height: 225.0px;" /></a>
<div class="section" id="what-you-will-need-ibt-2">
<h2>What You Will Need (IBT_2)<a class="headerlink" href="#what-you-will-need-ibt-2" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>An Arduino Mega or clone (or an Uno if you don’t need WiFi or Ethernet)</p></li>
<li><p>An Arduino Motor Shield (or another board for your service track for the upgrade option)</p></li>
<li><p>An IBT_2 Motor Board (1 board for the upgrade option, 2 for the replace option)</p></li>
<li><p>Version 3.1.0 or later of the DCC++ EX Command Station Software</p></li>
<li><p>10k or a even a 1k Resistor (Optional)</p></li>
<li><p>Some Jumper Wires</p></li>
</ul>
<p>For this option, we assume that many of you may have started off with the Arduino Mega with Arduino Motor Shield (or clones) and are here because you are making the step up to something that can handle more current, and therefore more locos. We will cover two options for how to use your IBT_2 motor board:</p>
<ol class="arabic simple">
<li><p><strong>“Upgrade”</strong> - Using ONE output of your Arduino Motor Shield to control your PROG track and ONE IBT_2 board to run your MAIN track.</p></li>
<li><p><strong>“Replace”</strong> - Using TWO IBT_2 boards to handle BOTH the MAIN and PROG tracks. You won’t need another motor controller. This is a Tinkerer or perhaps an Engineer option since it requires a little more knowledge and abilities.</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We can’t say it enough, this board can pump out some Amps. Be careful! Put fuses on the connection to each rail and limit the current to a safe level in your config.h file. We have a saying at DCC-EX, if you need more than 5 Amps to run locos, then you need to add power districts, not more Amps. The voltage to the track will be 2 to 3 volts higher using the same power supply than it is with Arduino type (L298) motor boards.</p>
</div>
<p>The IBT_2 uses N-Channel Power MOSFETS (a type of Transistor) inside its 2 BTS7960B Integrated Circuits. Each of those ICs makes is just a half H-Bridge circuit, it takes two of them to make the full H-Bridge. Don’t be confused, each of these boards can only handle one track. The Arduino board is a DUAL full H-Bridge, that is how it can handle 2 tracks.</p>
<p>Anything with MOSFETS in them is more efficient than something with Bipolar Junction Transistors (BJTs) like the L298 on the Arduino and Deek Robot Motor Shields. That means <strong>there is no voltage drop to the tracks</strong> like there is for those boards. Keep that in mind because that means <strong>there can be an extra 2 to 3 volts to your track</strong>. Your trains will run faster than they did before and things could overheat if they were able to handle the 12V reaching the track from a 14.5V power supply, but don’t like the full 14+ volts.</p>
</div>
<div class="section" id="which-option-should-you-choose-ibt-2">
<h2>Which Option Should You Choose? (IBT_2)<a class="headerlink" href="#which-option-should-you-choose-ibt-2" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>These options both use the “standard accuracy” waveform (This means the 1 and 0 pulses can vary a tiny bit from their 58 and 116uS duration). This is not a problem for virtually all decoders and would usually only be noticed by a sniffer checking the signal for accuracy (Like DCCInspector-EX). We use 2 GPIO pins to generate the DCC signal. This saves you from having to create a small 1 transistor and 2 resistor inverter circuit to only use 1 pin. If you want to use “high accuracy” mode because you need to free an Arduino pin or some other reason, and you like to solder, please see <a class="reference external" href="high-accuracy.html">High Accuracy Waveform Mode</a></p>
</div>
<div class="section" id="upgrade-ibt-2">
<h3>Upgrade (IBT_2)<a class="headerlink" href="#upgrade-ibt-2" title="Permalink to this headline">¶</a></h3>
<p>The main benefit of using the upgrade option, keeping the Arduino Motor Shield for programming and adding the IBT_2 for providing more current for your MAIN track, is that you already have a working system for programming, and therefore need to make fewer changes. The other reason is that current sensing for programming requires more sensitivity that simply being able to detect a short condition, which is all you need on MAIN.</p>
<p>The circuitry on the Arduino Motor Shield is designed to measure current from just 0 to 2 Amps in the 1023 steps of the analog input pin of an Arduino Mega (it has a 10 bit analog-to-digital converter (ADC)), and 10 bits can hold an integer from 0 to 1023). Measuring 5 or 10 amps in the same number of steps obviously means a loss of resolution. This is not necessarily a bad thing, but is worth noting.</p>
<p>It would be possible to just use fuses to both rails of your MAIN track to protect for shorts on the track and not have to have an external current sense board as long at you also had protection in your power supply to protect against a short in the board itself. Just note that without a current sense board, the Command Station would not be able to automatically turn off power to the board in the event of a short and current monitoring, like in the JMRI DCC++ monitor, will not report main track current.</p>
</div>
<div class="section" id="replace-ibt-2">
<h3>Replace (IBT_2)<a class="headerlink" href="#replace-ibt-2" title="Permalink to this headline">¶</a></h3>
<p>The main benefit of the replace option, using 2 IBT_2 boards, is that you don’t have to have two different types of boards. If you are building a new CS and don’t already have an Arduino Motor Shield, you will need two of the IBT_2 boards.</p>
<p>To use this option <em>and</em> be able to program locos, you <strong>must</strong> have an current sense capability. These boards <em>do</em> have a current sense output, but you may want to modify that or use an external current sense board. We will cover more about that later. Accurate current sense lets you detect the acknowledgement (ACK) pulses from a loco on your programming track. It also allows the CS to monitor for a short and automatically cut the power to the tracks if there is an overload condition (a short).</p>
</div>
</div>
<div class="section" id="upgrading-use-the-arduino-motor-shield-and-the-ibt-2">
<h2>Upgrading (Use the Arduino Motor Shield AND the IBT_2)<a class="headerlink" href="#upgrading-use-the-arduino-motor-shield-and-the-ibt-2" title="Permalink to this headline">¶</a></h2>
<p>For this installation we are going to assume you already have a working CS or at least have all the parts you need as listed above.</p>
<p>If you need instructions on how to install the Arduino Motor Shield, see <a class="reference external" href="../../get-started/assembly.html">Arduino Motor Shield Assembly</a></p>
<div class="section" id="what-we-are-going-to-do-upgrade">
<h3>What We Are Going To Do (Upgrade)<a class="headerlink" href="#what-we-are-going-to-do-upgrade" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Use just 1 output of your existing Arduino Motor Shield for your program track with no hardware changes</p></li>
<li><p>Add an IBT_2 (BTS7960) Motor Board to replace the “A” output of the motor shield to power your MAIN track</p></li>
<li><p>Move a few wires and connect a few jumpers to your IBT_2</p></li>
<li><p>Optionally add a current sense resistor to the IBT_2</p></li>
<li><p>Change your motor board type in your config.h file</p></li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Instead of bending out the current sense pin of the Arduino Motor Shield and using the same A0 pin for the IBT_2 current sense, we are using pin A5. Both outputs of the motor shield are still connected, we just don’t enable the A or main side. DO NOT try to use the A output of the motor shield! You will have no current sense and no short circuit protection.</p>
</div>
</div>
<div class="section" id="steps-upgrade">
<h3>Steps (Upgrade)<a class="headerlink" href="#steps-upgrade" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li><p>Make sure all power supplies are disconnected from your Arduino, The Motor Shield, and the IBT_2</p></li>
<li><p>Disconnect the wires coming out of output A of the Arduino Motor Shield that normally connect to your MAIN track.</p></li>
<li><p>Move the two wires we just disconnected from the motor shield and connect them to the M+ and M- Screw terminals of the IBT_2. If you will be using power districts or wanting to connect the main and prog tracks together when prog is not in use, keep the polarity of the rails the same with reference to each other. In other words, if you connect + to the left rail, then always keep + on the rail to the left as viewed from a train sitting on the track. We need to keep the phase of the DCC signal in sync between power districts.</p></li>
<li><p>Option - You may need to connect or solder a 10k or smaller resistor between pin 5 or 6 and ground on the IBT_2 (shown as R1 in Figure 1). There is already a 10k resistor on each chip, which gives us a resistance of 5k when we connect both current sense outputs together. See the notes below for more detail about current sense and a suggestion for using an external current sense board.</p></li>
<li><p>The diagrams below also show an optional diode protection circuit. If you don’t test your board first to make sure that the current you will be using does not put more that 5V on your Arduino analog pin, this will keep you from destroying the input. It is a 5 or 5.1 zener diode (1N4733A, 1N5231B, NZX5V1B, BZX55C5V1, etc.). R2 can be whatever you have on hand. We recommend 2k - 10k.</p></li>
<li><p>Select your IBT_2 board in the config.h file.</p></li>
<li><p>Upload the new sketch to your Arduino Mega</p></li>
</ol>
<p>Use the following diagrams to connect pins from the Arduino Mega to the IBT_2:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 67%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Arduino</p></th>
<th class="head"><p>IBT_2</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>4 (enable)</p></td>
<td><p>3,4  (R_EN, L_EN)</p></td>
</tr>
<tr class="row-odd"><td><p>5 (signal 1)</p></td>
<td><p>2 (LPWM)</p></td>
</tr>
<tr class="row-even"><td><p>6 (signal 2)</p></td>
<td><p>1 (RPWM)</p></td>
</tr>
<tr class="row-odd"><td><p>A5 (CS MAIN)</p></td>
<td><p>5,6, R1a  (R_IS, L_IS, R1a)</p></td>
</tr>
<tr class="row-even"><td><p>5V</p></td>
<td><p>7 (Vcc)</p></td>
</tr>
<tr class="row-odd"><td><p>GND</p></td>
<td><p>GND, R1b</p></td>
</tr>
</tbody>
</table>
<p>Table 1 - Wiring diagram</p>
<p>Here is a visual diagram. R1 (current sense modifier), R2 (diode current limiter) and D1 (5.1V Zener protection diode) are optional. See current sense notes below. Click to enlarge:</p>
<div class="figure align-default" id="id1">
<a class="reference internal image-reference" href="../../_images/ibt_wiring.png"><img alt="IBT_2 Wiring 1" src="../../_images/ibt_wiring.png" style="width: 275.79999999999995px; height: 348.59999999999997px;" /></a>
<p class="caption"><span class="caption-text">Figure 1. - Wiring Schematic</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
<p>It should look like following. Note we have included the Arduino Mega and have the Arduino Motor shield off to the side for reference. The motor shield would obviously normally be stacked on top of the Arduino. However, some people might not use the motor shield and instead will have another board to use for their programming track. In this case, they would connect the IBT_2 to the same pins directly on the Arduino microcontroller. Also note the jumper wiring that shows pin 4 or the Arduino connecting to pins 3 and 4 on the IBT_2 and A5 connected to pins 5 and 6. As with most of our diagrams, you can click on them to enlarge them.</p>
<div class="figure align-default" id="id2">
<a class="reference internal image-reference" href="../../_images/ibt_2_wiring_fritz.png"><img alt="IBT_2 Wiring 2" src="../../_images/ibt_2_wiring_fritz.png" style="width: 585.0px; height: 342.0px;" /></a>
<p class="caption"><span class="caption-text">Figure 2. - Wiring visual layout</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We are going to edit your config.h file. If this is your first time using the Command Station software and you do not have a config.h file, rename your config.example.h file to config.h.</p>
</div>
<p>Launch the Arduino IDE (or whatever editor you use) and open the CommandStation-EX project. Find the config.h file. look for the following lines of code:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// DEFINE MOTOR_SHIELD_TYPE BELOW ACCORDING TO THE FOLLOWING TABLE:</span>
<span class="c1">//</span>
<span class="c1">//  STANDARD_MOTOR_SHIELD : Arduino Motor shield Rev3 based on the L298 with 18V 2A per channel</span>
<span class="c1">//  POLOLU_MOTOR_SHIELD   : Pololu MC33926 Motor Driver (not recommended for prog track)</span>
<span class="c1">//  FUNDUMOTO_SHIELD      : Fundumoto Shield, no current sensing (not recommended, no short protection)</span>
<span class="c1">//  IBT_2_WITH_ARDUINO    : IBT_2 Motor Board on MAIN and Arduino Motor Shield on PROG</span>
<span class="c1">//  FIREBOX_MK1           : The Firebox MK1</span>
<span class="c1">//  FIREBOX_MK1S          : The Firebox MK1S</span>
<span class="c1">//   |</span>
<span class="c1">//   +-----------------------</span>
<span class="c1">//</span>
<span class="cp">#define MOTOR_SHIELD_TYPE STANDARD_MOTOR_SHIELD</span>
</pre></div>
</div>
<p>Change the last line to look like this. To be sure of your spelling, you can copy and paste IBT_2_WITH_ARDUINO to replace STANDARD_MOTOR_SHIELD</p>
<p><code class="docutils literal notranslate"><span class="pre">#define</span> <span class="pre">MOTOR_SHIELD_TYPE</span> <span class="pre">IBT_2_WITH_ARDUINO</span></code></p>
<p>Upload the sketch to your arduino. If you need help on how to upload a sketch, see <a class="reference external" href="../../get-started/index.html">Getting Started</a></p>
<p>Please see <a class="reference internal" href="#important-notes-on-current-sensing-ibt-2"><span class="std std-ref">Important Notes on Current Sensing (IBT_2)</span></a>.</p>
</div>
</div>
<div class="section" id="replacing-using-one-ibt-2-for-main-and-another-for-prog">
<h2>Replacing (Using One IBT_2 for MAIN and another for PROG)<a class="headerlink" href="#replacing-using-one-ibt-2-for-main-and-another-for-prog" title="Permalink to this headline">¶</a></h2>
<p>This section will cover how to use 2 IBT_2 boards, one for MAIN and one for PROG if you do not already have an Arduino Motor Shield or clone. Be careful as the IBT_2 can deliver much more current than you need for a programming track. If you install 1 Amp fuses in between the IBT_2 outputs and both rails of your programming track, that and the lower trip current we set in the CS for the programming track should protect your layout.</p>
<div class="section" id="what-we-are-going-to-do-replace">
<h3>What We Are Going to Do (Replace)<a class="headerlink" href="#what-we-are-going-to-do-replace" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Use Two (2) IBT_2 (BTS7960) Motor Boards to run your MAIN and PROG tracks</p></li>
<li><p>Use jumper wires to connect the IBT_2 to the Arduino and the IBT_2 outputs to your tracks</p></li>
<li><p>Optionally add current sense resistors to the IBT_2</p></li>
<li><p>Change your motor board type in your config.h file</p></li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>You will need some form of current sense if you wish to program locos and detect overload conditions (short circuit) on your tracks.</p>
</div>
</div>
<div class="section" id="steps-replace">
<h3>Steps (Replace)<a class="headerlink" href="#steps-replace" title="Permalink to this headline">¶</a></h3>
<p>The same rules as above apply to using 2 boards. The only difference is that we would use one IBT_2 board for Main and another for PROG. That wiring would look like this:</p>
<p>Please see <a class="reference internal" href="#important-notes-on-current-sensing-ibt-2"><span class="std std-ref">Important Notes on Current Sensing (IBT_2)</span></a>.</p>
<p>TODO: Fritzing image of 2 ibt 2 boards here</p>
<p>Use the following diagrams to connect pins from the Arduino Mega to the IBT_2 for your MAIN track:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 67%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Arduino</p></th>
<th class="head"><p>IBT_2 MAIN</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>4 (enable)</p></td>
<td><p>3,4  (R_EN, L_EN)</p></td>
</tr>
<tr class="row-odd"><td><p>5 (signal 1)</p></td>
<td><p>2 (LPWM)</p></td>
</tr>
<tr class="row-even"><td><p>6 (signal 2)</p></td>
<td><p>1 (RPWM)</p></td>
</tr>
<tr class="row-odd"><td><p>A5 (CS MAIN)</p></td>
<td><p>5,6, R1a  (R_IS, L_IS, R1a)</p></td>
</tr>
<tr class="row-even"><td><p>5V</p></td>
<td><p>7 (Vcc)</p></td>
</tr>
<tr class="row-odd"><td><p>GND</p></td>
<td><p>GND, R1b</p></td>
</tr>
</tbody>
</table>
<p>Use the following diagrams to connect pins from the Arduino Mega to the IBT_2 for your PROG track:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 67%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Arduino</p></th>
<th class="head"><p>IBT_2 PROG</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td colspan="2"><p>11 (enable)   | 3,4  (R_EN, L_EN)</p></td>
</tr>
<tr class="row-odd"><td colspan="2"><p>12 (signal 1) | 2 (LPWM)</p></td>
</tr>
<tr class="row-even"><td colspan="2"><p>13 (signal 2) | 1 (RPWM)</p></td>
</tr>
<tr class="row-odd"><td><p>A4 (CS MAIN)</p></td>
<td><p>5,6, R1a  (R_IS, L_IS, R1a)</p></td>
</tr>
<tr class="row-even"><td><p>5V</p></td>
<td><p>7 (Vcc)</p></td>
</tr>
<tr class="row-odd"><td><p>GND</p></td>
<td><p>GND, R1b</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="important-notes-on-current-sensing-ibt-2">
<h2>Important Notes on Current Sensing (IBT_2)<a class="headerlink" href="#important-notes-on-current-sensing-ibt-2" title="Permalink to this headline">¶</a></h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Make sure your board has the expected current sensing resistors (see below) and that their value is correct for the maximum current you expect to use. Also, make sure you don’t apply more than 5V to the Arduino Analog pin. Our calculations use NOMINAL values, but these chips can vary widely in how much voltage they report per Amp of current at the output. The value of your resistor will also affect this.</p>
</div>
<p>Please do the following to ensure you won’t damage the Arduino, your layout, or yourself:</p>
<ul class="simple">
<li><p>Test your board to see what voltage it reports for 2 or 3 different currents and extrapolate to make sure that at your required current, example 5A, to CS output does not produce more than 5V.</p></li>
<li><p>Use a 5.1V zener diode (D1) and current limiting resistor (R2). This would normally be a 5k Ohm resistor but can be anything from 270 to 10k. The Diode can be 5V or 5.1V like a 1N4733A, 1N5231B, etc. Note that after 3.5V the response is no longer linear when using the diode, so you you may want to design your system to output its range between 0 and 4V and use 5V as the over limit setting.</p></li>
<li><p>Check your board for at least 2 resistors that are labeled “103”, you will need a magnifier or to take a picture with your phone and zoom in. 103 = 10k (10 followed by 3 zeros). These are the second from the left resistor in each bank of 4 (R5 and R6). See Figure 3. When we tie the two CS outputs together, that gives us 5k of resistance from which to measure a voltage drop and convert that to current. If you added another 10k resistor (R1) in parallel with the others, that would give you 3.3k which reduces the voltage to the Arduino analog pin to be able to measure higher currents.</p></li>
<li><p>Put a 5A fuse on each output leg going to your track.</p></li>
</ul>
<div class="figure align-default" id="id3">
<a class="reference internal image-reference" href="../../_images/ibt_2_resistors.jpg"><img alt="IBT_2 Resistors" src="../../_images/ibt_2_resistors.jpg" style="width: 375.9px; height: 171.5px;" /></a>
<p class="caption"><span class="caption-text">Figure 3. - 10k (103) current sense resistors</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</div>
<p>The spec sheet of the BTS7960B states that the “expected” (aka nominal) value for the ratio of output current to the current reported at the current sense pin is 8500 to 1. That means if you have 1 Amp of output current you will get .176 mA of current at the CS pin. If we apply that through our 5k of resistance (V = I*R) we would see .588 Volts at the output connected to our Arduino analog pin. Since the response is linear, we get .588 Amps per Volt. If we have 3A of current to the track, we would have 1.75V. And for 5 Amps, the voltage would be 2.94V. So far, so good, BUT, the tolerance and difference between what is “expected” and what will pass as “acceptable” is huge. The 8500 ratio we expect can be as low as 3000 and has high as 14,000! This means that a 3A current can be reported as anything from 1V to 5V on the CS pin. But what happens at 5A on one of these boards? The answer is that you could have as much as 8.33V connected to your Arduino! In other words, <strong>You could destroy the analog input pin on your Arduino</strong>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If you are going to use more than 3 Amps, you should add a 10k or less current sense resistor (R1) and a 5V Zener diode and series resistor protection circuit (D1 and R2). See the section above “Important Notes on Current Sensing”. An additional 10k resistor would give you .392 Volts per Amp and will require a small change to your sketch to adjust your current conversion factor (usually a value of 10). A 2.2k resistor would allow you to measure up to 10A, but the larger the current range, the less sensitivity and accuracy you can get. Besides, we should use boosters and power districts if we need more than 5 Amps, right? ;)</p>
</div>
<div class="section" id="modifying-your-motor-board-definition-to-give-the-correct-current-sense-factor">
<h3>Modifying Your Motor Board Definition To Give The Correct Current Sense Factor<a class="headerlink" href="#modifying-your-motor-board-definition-to-give-the-correct-current-sense-factor" title="Permalink to this headline">¶</a></h3>
<p>If you add a parallel resistor to increase your current sensing range or find your readings are not correct, you will need to adjust your current sense factor. For an unmodified board, a value of 7 is usually good. If you add a 10k parallel resistor to get more current range, you probably need to change it to 10. If you can test with known resistance values to know exacly what voltage it reported to your analog pin for 2 or more currents, you can use a simple formulat to calculate it. Everything you need to create your own motor board defintion is here:</p>
<p><a class="reference external" href="https://dcc-ex.com/advanced-setup/motor-board-config.html#your-board-is-not-in-the-supported-list">Creating a Custom Motor Board Definition</a></p>
</div>
</div>
<div class="section" id="using-external-current-sense">
<h2>Using External Current Sense<a class="headerlink" href="#using-external-current-sense" title="Permalink to this headline">¶</a></h2>
<p>Using an external current sense board instead of the onboard current sense included with the IBT_2 can give us a little more control over the sensitivity of our circuit (ability to read low currents such as one N scale loco sitting still on the track. Circuits and boards we tested are the MAX471 (up to 3A), the Pololu ACS724 (5A or 10A boards), and a 5A current sense transformer for use with one output wire wrapped through it going directly to the track.</p>
<p><strong>*TODO: Add help or point to a section for external current sense boards*</strong></p>
</div>
<div class="section" id="parts-list-ibt-2">
<h2>Parts List (IBT_2)<a class="headerlink" href="#parts-list-ibt-2" title="Permalink to this headline">¶</a></h2>
<p>Mean Well LRS-150-15
Enclosed Switchable Power Supply 1U Profile, 150W 15V 10A
<a class="reference external" href="http://amazon.com/gp/product/B019GYOPSS/">http://amazon.com/gp/product/B019GYOPSS/</a>
$23.38 +tax; prime shipping</p>
<p>ELEGOO MEGA 2560 R3 Board ATmega2560 ATMEGA16U2 + USB Cable
<a class="reference external" href="https://www.amazon.com/gp/product/B01H4ZLZLQ">https://www.amazon.com/gp/product/B01H4ZLZLQ</a>
$16.99 +tax; prime shipping</p>
<p>ACS724 Current Sensor Carrier 0 to 10A (this one has 400mv/A sensitivity)
<a class="reference external" href="https://www.pololu.com/product/4042">https://www.pololu.com/product/4042</a>
$9.95 + $3.95 shipping</p>
<p>DuPont pin M/F jumper wires 20cm – an assortment is fine
<a class="reference external" href="https://www.amazon.com/dp/B07GD2BWPY">https://www.amazon.com/dp/B07GD2BWPY</a>
$5.79 +tax; prime shipping</p>
<p>Single Motor Driver Board H-Bridge IBT_2, 3-36V, 15A, Peak 43A
various sellers, prices and delivery methods. $7 to $14.
Here is a pack of two:
<a class="reference external" href="https://www.amazon.com/BTS7960-Driver-Module-Arduino-Current/dp/B07TFB22H5/ref=asc_df_B07TFB22H5/?tag=hyprod-20&amp;linkCode=df0&amp;hvadid=366016835942&amp;hvpos=&amp;hvnetw=g&amp;hvrand=9794586518900556692&amp;hvpone=&amp;hvptwo=&amp;hvqmt=&amp;hvdev=c&amp;hvdvcmdl=&amp;hvlocint=&amp;hvlocphy=9009681&amp;hvtargid=pla-790247286209&amp;psc=1&amp;tag=&amp;ref=&amp;adgrpid=80266838630&amp;hvpone=&amp;hvptwo=&amp;hvadid=366016835942&amp;hvpos=&amp;hvnetw=g&amp;hvrand=9794586518900556692&amp;hvqmt=&amp;hvdev=c&amp;hvdvcmdl=&amp;hvlocint=&amp;hvlocphy=9009681&amp;hvtargid=pla-790247286209">https://www.amazon.com/BTS7960-Driver-Module-Arduino-Current/dp/B07TFB22H5/ref=asc_df_B07TFB22H5/?tag=hyprod-20&amp;linkCode=df0&amp;hvadid=366016835942&amp;hvpos=&amp;hvnetw=g&amp;hvrand=9794586518900556692&amp;hvpone=&amp;hvptwo=&amp;hvqmt=&amp;hvdev=c&amp;hvdvcmdl=&amp;hvlocint=&amp;hvlocphy=9009681&amp;hvtargid=pla-790247286209&amp;psc=1&amp;tag=&amp;ref=&amp;adgrpid=80266838630&amp;hvpone=&amp;hvptwo=&amp;hvadid=366016835942&amp;hvpos=&amp;hvnetw=g&amp;hvrand=9794586518900556692&amp;hvqmt=&amp;hvdev=c&amp;hvdvcmdl=&amp;hvlocint=&amp;hvlocphy=9009681&amp;hvtargid=pla-790247286209</a>
$15.51 +tax; prime shipping</p>
</div>
<div class="section" id="tech-notes-ibt-2">
<h2>Tech Notes (IBT_2)<a class="headerlink" href="#tech-notes-ibt-2" title="Permalink to this headline">¶</a></h2>
<div class="section" id="motor-board-definitions-ibt-2">
<h3>Motor Board Definitions (IBT_2)<a class="headerlink" href="#motor-board-definitions-ibt-2" title="Permalink to this headline">¶</a></h3>
<p>The choice of motor driver is set in the config.h file. It is set in the following line:</p>
<p><code class="docutils literal notranslate"><span class="pre">#define</span> <span class="pre">MOTOR_SHIELD_TYPE</span> <span class="pre">[Motor</span> <span class="pre">Board</span> <span class="pre">Type]</span></code></p>
<p>The default is “STANDARD_MOTOR_SHIELD” For Arduino and clone shields.</p>
<p>If you want to change your motor shield or create a definition for one that does not yet have built-in support, you can follow the simple instructions in the <a class="reference external" href="../motor-board-config.html">Motor Board Config Section</a></p>
<p>For the Engineers, the defintions and implementation for motor board control are in the following files:</p>
<blockquote>
<div><p><strong>MotorDrivers.h</strong>  - Contains the definitions for all the currently supported motor boards
<strong>MotorDriver.h</strong> - Creates the “MotorDriver” C++ class that defines the data type for a motor controller
<strong>MotorDriver.cpp</strong> - The routines that control the operation of a motor controller (Power, Current Sense, etc.)</p>
</div></blockquote>
<p>Normally you would never need to get into these files, we just mention them because it can be helpful to see the examples in the code if you want to learn more about how to customize your motor board definition or see how things work.</p>
</div>
<div class="section" id="ibt-2-schematic">
<h3>IBT_2 schematic<a class="headerlink" href="#ibt-2-schematic" title="Permalink to this headline">¶</a></h3>
<p>Below is a link to the IBT_2 schematic. Click to enlarge.</p>
<a class="reference internal image-reference" href="../../_images/IBT_2_schematic.jpg"><img alt="../../_images/IBT_2_schematic.jpg" src="../../_images/IBT_2_schematic.jpg" style="width: 525.0px; height: 237.5px;" /></a>
<p>Below is the Handson Technology datasheet, recommended reading for Tinkerers and Engineers</p>
<p><a class="reference external" href="../../_static/documents/bts7960-motor-driver.pdf">Handson Technology BTS7960 High Current 43A H-Bridge Motor Driver</a></p>
<blockquote>
<div><p>TODO: this has to go somewhere:
There are two ways to monitor motor board current, one is at the input of the board and the other is at the output. We will cover both of these methods in the <a class="reference internal" href="IRF3205-motor-board-setup.html#important-notes-on-current-sensing"><span class="std std-ref">Important Notes on Current Sensing</span></a> section.</p>
<p>Also, mention “high accuracy mode” and include the circtuit for that.</p>
</div></blockquote>
<p>Updated June 30, 2021</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="IRF3205-motor-board-setup.html" class="btn btn-neutral float-right" title="IRF3205 Motor Board Setup" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="L298N-motor-board-setup.html" class="btn btn-neutral float-left" title="L298N Motor Board Setup" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, 2021 - Fred Decker, Mani Kumar.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>