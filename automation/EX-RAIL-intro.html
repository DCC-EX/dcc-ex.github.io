

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Introduction to EX-RAIL Automation &mdash; DCC++ EX  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/dccex_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/js/platform.js"></script>
        <script src="../_static/js/extra.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="EX-RAIL Reference" href="EX-RAIL-ref.html" />
    <link rel="prev" title="Automation (EX-RAIL) BETA!" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
          

          
            <a href="../index.html">
          

          
            
            <img src="../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../get-started/index.html">Get Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../get-started/levels.html">Levels</a></li>
<li class="toctree-l2"><a class="reference internal" href="../get-started/assembly.html">Assembly</a></li>
<li class="toctree-l2"><a class="reference internal" href="../get-started/wifi-setup.html">WiFi Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../get-started/installer.html">Install using the Automated Installer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../get-started/arduino-ide.html">Install using the Arduino IDE</a></li>
<li class="toctree-l2"><a class="reference internal" href="../get-started/controllers.html">Choosing a Controller (Throttle)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../get-started/diagnosing-issues.html">Diagnosing Issues (Troubleshooting)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../advanced-setup/index.html">Advanced Setup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../advanced-setup/wifi-config.html">WiFi Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../advanced-setup/motor-board-config.html">Motor Board Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../advanced-setup/startup-config.html">Startup Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../advanced-setup/supported-motorboards/index.html">Supported Motorboards Setup Notes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../advanced-setup/supported-motorboards/L298N-motor-board-setup.html">L298N Motor Board Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="../advanced-setup/supported-motorboards/IBT_2-motor-board-setup.html">IBT_2 BTS7960 Motor Board</a></li>
<li class="toctree-l3"><a class="reference internal" href="../advanced-setup/supported-motorboards/IRF3205-motor-board-setup.html">IRF3205 Motor Board Setup</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../advanced-setup/supported-microcontrollers/index.html">Supported Microcontrollers Setup Notes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../advanced-setup/supported-microcontrollers/wifi-mega.html">Mega+WiFi Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../advanced-setup/supported-microcontrollers/nano.html">Arduino Nano Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="../advanced-setup/supported-microcontrollers/nano-every.html">Nano Every</a></li>
<li class="toctree-l3"><a class="reference internal" href="../advanced-setup/supported-microcontrollers/teensy.html">Teensy</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../advanced-setup/high-accuracy.html">High Accuracy Waveform Mode</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../throttles/index.html">Throttles</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../throttles/protocols.html">WiThrottle Server, Web Server, DCC++ API Explained</a></li>
<li class="toctree-l2"><a class="reference internal" href="../throttles/ex-webthrottle.html">DCC++ EX Web Throttle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../throttles/engine-driver.html">Engine Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../throttles/withrottle.html">WiThrottle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../throttles/dccpp-cab.html">DCCpp CAB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../throttles/locontrol.html">Locontrol</a></li>
<li class="toctree-l2"><a class="reference internal" href="../throttles/cab-engineer.html">Cab Engineer: DCC Throttle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../throttles/digitrainspro.html">DigiTrainsPro</a></li>
<li class="toctree-l2"><a class="reference internal" href="../throttles/srcpclient.html">SRCP Client for iOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../throttles/streamdeck.html">Elgato Stream Deck</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Automation (EX-RAIL) BETA!</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Introduction to EX-RAIL Automation</a></li>
<li class="toctree-l2"><a class="reference internal" href="EX-RAIL-ref.html">EX-RAIL Reference</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/hardware/index.html">Hardware</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../reference/hardware/microcontroller-boards.html">Microcontroller Boards</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/hardware/motor-boards.html">Motor Boards</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/hardware/wifi-boards.html">WiFi Boards</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/hardware/ethernet-boards.html">Ethernet Boards</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/hardware/i2c-displays.html">I2C Displays</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/hardware/power-supplies.html">Power Supplies</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/hardware/shopping-list.html">Shopping List</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../reference/software/hal.html">Overview of DCC++EX HAL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/software/hal-config.html">I/O Device Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/software/release-notes.html">Release Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/software/command-reference.html">DCC++ EX Command Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/software/command-summary.html">DCC++ EX Command Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/software/diagnostic-d-ack-command.html">Diagnostics <code class="docutils literal notranslate"><span class="pre">&lt;D</span> <span class="pre">ACK&gt;</span></code> Command</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/software/diagnostic-d-command.html">Diagnostics <code class="docutils literal notranslate"><span class="pre">&lt;D&gt;</span></code> Command</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/accessories/suppliers.html">Hardware, Software, and Accessory Suppliers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/downloads/index.html">Downloads</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../reference/downloads/documents.html">Documents</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/downloads/schematics.html">Schematics</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../reference/tools/index.html">Diagnostic Tools</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../reference/tools/diagnostic-tools.html">DCC Diagnostic Tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/tools/serial-monitor.html">Using a Serial Monitor</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../reference/wire-gauge.html">Wire Gauge Information</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../download/index.html">Software Downloads</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../download/commandstation.html">Command Station Downloads</a></li>
<li class="toctree-l2"><a class="reference internal" href="../download/esp8266.html">ESP8266 Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../download/dcc-inspector-ex.html">DCC Inspector-EX</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../projects/index.html">Projects</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../projects/railsnail-bluetooth.html">RailSnail’s Complete Blutooth DCC++EX Command Station</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/index.html">Contributing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../contributing/requirements.html">Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing/website.html">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing/development.html">Development</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing/contactus.html">Contact us</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../roadmap/index.html">DCC-EX Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../support/index.html">Support</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../support/create-ticket.html">Submit a Support Ticket</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../about/index.html">About</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../about/rewrite.html">What’s New in DCC++ EX?</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">DCC++ EX</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Automation (EX-RAIL) BETA!</a> &raquo;</li>
        
      <li>Introduction to EX-RAIL Automation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/automation/EX-RAIL-intro.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="introduction-to-ex-rail-automation">
<h1>Introduction to EX-RAIL Automation<a class="headerlink" href="#introduction-to-ex-rail-automation" title="Permalink to this headline">¶</a></h1>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>EX-RAIL is in Beta testing. It is very far along, but you may experience unexpected issues.</p>
<p>We can use your help in final testing and ideas for new features. Please see us on Discord <a class="reference external" href="https://discord.gg/y2sB4Fp">here</a> to participate in the Beta, and get notified of new code releases.</p>
<p>You can find instructions to download the EX-RAIL version of the software <a class="reference internal" href="../download/commandstation.html#getting-the-ex-rail-beta-development-version"><span class="std std-ref">here</span></a>.</p>
</div>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>EX-RAIL is an “<strong>EX</strong>tended <strong>R</strong>ailroad <strong>A</strong>utomation <strong>I</strong>nstruction <strong>L</strong>anguage”
that can easily be used to describe sequential actions to automatically take place on your model layout. These actions are defined programmatically in a simple command script file, and uploaded to the Command Station once to configure it. EX-RAIL will then run automatically on CS startup.</p>
<p>To begin, let’s define a few terms:</p>
<p><strong>SEQUENCE</strong> - Simply a list of things to be done in order. These things might be to actually drive a train around, or merely to set some turnouts or flash some scene or panel lights. Actions can be made to wait for conditions to be met, like a sensor detecting a train, a button being pushed, or a period of time elapsing.</p>
<p><strong>ROUTE</strong> - A SEQUENCE that is made visible to EngineDriver with a readable name so the user can press a button to get the sequence executed. This might be best used to set a series of turnouts and signals to create a route through the layout.</p>
<p><strong>AUTOMATION</strong> - A SEQUENCE that is made visible to EngineDriver so that a user can hand over a loco and let EX-RAIL drive the train away, following each step listed in the sequence.</p>
<div class="sidebar">
<p class="sidebar-title">A note from the Author</p>
<p>My original aim was to see if I could create an automated layout with lots going on, that didn’t just run around in circles. Having looked at JMRI (briefly, I must say) and DCC++, I began to wonder whether I could actually make a simpler automation system, and run it entirely on the Arduino used for DCC++.</p>
<p>Some of the automation techniques I read about, using jython scripts in   JRMI, seem to require extensive programming skills and complex table configurations which appeared awkward to me, despite my years of programming in dozens of languages.</p>
<p>It seemed to me that basing an automation on block occupancy detection leaves a lot of complex technical problems to be solved… and wanting to be cheap, I didn’t want to invest in a range of block occupancy detectors, or ABC braking modules, which are all very well on circular layouts, but not good at complex crossings or single line operations with passing places. Also, I didn’t want the automation to be an obvious cycle of movements… some random timings and decisions need to be introduced so that two trains don’t always arrive at the same place in the same order, nor go on the same journey in a predictable cycle.</p>
<p>By reversing the usual assumptions, I think I have a workable, extensible and cheap solution.</p>
<p>Because the original DCC++ used a software design inappropriate for internal automation, I had to start by rewriting the entire Command Station code and this became DCC-EX, so automation has been in the plan from the start.</p>
<ul class="simple">
<li><p>Chris Harlow</p></li>
</ul>
</div>
</div>
<div class="section" id="things-you-can-do-with-ex-rail">
<h2>Things You Can Do With EX-RAIL<a class="headerlink" href="#things-you-can-do-with-ex-rail" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Create “Routes” which set multiple turnouts and signals at the press of a button in EngineDriver (other WiThrottle-compatible throttles are available)</p></li>
<li><p>Animate accessories such as lights, crossings, or cranes using “Sequences”</p></li>
<li><p>Automatically drive multiple trains simultaneously, and manage complex interactions such as single line working and crossovers by setting up “Automations”</p></li>
<li><p>Drive trains manually, and hand a train over to an Automation</p></li>
<li><p>Intercept turnout changes to automatically adjust signals or other turnouts</p></li>
<li><p>Turn on the coffee pot when the train reaches the station</p></li>
</ul>
</div>
<div class="section" id="what-you-don-t-need">
<h2>What You Don’t Need<a class="headerlink" href="#what-you-don-t-need" title="Permalink to this headline">¶</a></h2>
<p>While extra functionality may be attained by using additional tools and applications, to get the benefit of EX-RAIL you don’t need anything more than a <em>DCC-EX Command Station, and the Arduino IDE</em> used to configure it.</p>
<p>You DON’T need:</p>
<ul class="simple">
<li><p>JMRI, or any additional utilities</p></li>
<li><p>EngineDriver, or any other WiThrottle app</p></li>
<li><p>A separate computer living under your layout</p></li>
<li><p>Knowledge of C++ or Python/Jython programming</p></li>
</ul>
</div>
<div class="section" id="how-it-works">
<h2>How It Works<a class="headerlink" href="#how-it-works" title="Permalink to this headline">¶</a></h2>
<p>A small amount of code in the CS, the EX-RAIL executor, lets you write an automation script in the form of simple, easy to use text commands that it interprets and runs on your layout. You don’t have to be a programmer and you don’t have to learn code. You simply add your own myAutomation.h file in the same program you use to upload the Command Station Software to your Arduino (the Arduino IDE, PlatformIO, etc). This means that you already have all the tools you will need, and there is nothing else to download or install. The method of creating your script file is described in the next section.</p>
<p>The EX-RAIL code is surprisingly small and requires very little PROGMEM (memory that holds the program code) or SRAM (the runtime workspace that stores variables and things the program needs) to operate. However, you will still need a Mega for your CS; the UNO and Nano memory is simply too small to include EX-RAIL with the rest of the Command Station code.</p>
<p>EX-RAIL automation is <em>much</em> (perhaps 2 orders of magnitude) more time efficient than the code required to process incoming requests from an external automation processor, or the continuous polling of every sensor.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The EX-RAIL code is only included in the compilation of the Command Station if the compiler detects a “myAutomation.h” file. If you don’t create that file, no extra space is wasted for something you don’t use.</p>
</div>
</div>
<div class="section" id="the-automation-process">
<h2>The Automation Process<a class="headerlink" href="#the-automation-process" title="Permalink to this headline">¶</a></h2>
<p>All routes, automations, etc step through a list of simple keywords until they reach a <code class="docutils literal notranslate"><span class="pre">DONE</span></code> keyword.</p>
<p>For a full list of keywords, see <a class="reference internal" href="EX-RAIL-ref.html#ex-rail-reference"><span class="std std-ref">EX-RAIL Reference</span></a></p>
<p>Automation scripts are added to your Command Station by creating a file called “myAutomation.h” in the same folder as CommandStation-EX.ino, and adding in the scripts as follows:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">EXRAIL</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">scripts</span><span class="w"></span>
<span class="w">  </span><span class="n">ENDEXRAIL</span><span class="w"></span>
</pre></div>
</div>
<p>Connecting your Arduino and pressing the Upload button in the usual way will save the file and upload your script into the Command Station.</p>
<p>To create the myAutomation.h file in the Arduino IDE, use the pulldown button and select New Tab (or simply press Ctrl+Shift+N).</p>
<a class="reference internal image-reference" href="../_images/Setup1.jpg"><img alt="Setup pulldown button" class="align-center" src="../_images/Setup1.jpg" style="width: 158.0px; height: 90.0px;" /></a>
<a class="reference internal image-reference" href="../_images/Setup2.jpg"><img alt="Setup pulldown menu" class="align-center" src="../_images/Setup2.jpg" style="width: 280.0px; height: 86.0px;" /></a>
<p>Enter the file name “myAutomation.h” (This is case sensitive)</p>
<a class="reference internal image-reference" href="../_images/Setup3.jpg"><img alt="Setup myAutomation.h" class="align-center" src="../_images/Setup3.jpg" style="width: 296.0px; height: 112.0px;" /></a>
<p>And type your script in, starting with EXRAIL and ending with ENDEXRAIL.</p>
<a class="reference internal image-reference" href="../_images/Setup4.jpg"><img alt="Setup Example file" class="align-center" src="../_images/Setup4.jpg" style="width: 436.0px; height: 258.0px;" /></a>
</div>
<div class="section" id="some-simple-examples">
<h2>Some Simple Examples<a class="headerlink" href="#some-simple-examples" title="Permalink to this headline">¶</a></h2>
<div class="section" id="example-1-creating-routes-for-engine-driver">
<h3>Example 1: Creating Routes for Engine Driver<a class="headerlink" href="#example-1-creating-routes-for-engine-driver" title="Permalink to this headline">¶</a></h3>
<p>A typical Route might be used to set a sequence of turnouts in response to a single button in Engine Driver, or a pushbutton on a fascia panel near a yard.
The EX-RAIL instructions to do this might look like</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">ROUTE</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;Coal Yard exit&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">THROW</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">CLOSE</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">DONE</span><span class="w"></span>
</pre></div>
</div>
<p>Or you can write it like this</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">ROUTE</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;Coal Yard exit&quot;</span><span class="p">)</span><span class="w">  </span><span class="n">THROW</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w">  </span><span class="n">CLOSE</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="w">  </span><span class="n">DONE</span><span class="w"></span>
</pre></div>
</div>
<p>Or add comments</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// This is my coal yard to engine shed route</span>
<span class="w">  </span><span class="n">ROUTE</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;Coal Yard exit&quot;</span><span class="p">)</span><span class="w">     </span><span class="c1">// appears in Engine Driver</span>
<span class="w">    </span><span class="n">THROW</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w">   </span><span class="c1">// throw turnout onto coal yard siding</span>
<span class="w">    </span><span class="n">CLOSE</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="w">   </span><span class="c1">// close turnout for engine shed</span>
<span class="w">    </span><span class="n">DONE</span><span class="w">    </span><span class="c1">// that&#39;s all folks!</span>
</pre></div>
</div>
<p>Of course, you may want to add signals, and time delays</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">SIGNAL</span><span class="p">(</span><span class="mi">77</span><span class="p">,</span><span class="mi">78</span><span class="p">,</span><span class="mi">79</span><span class="p">)</span><span class="w">  </span><span class="c1">// see the Defining Signals section</span>
<span class="n">SIGNAL</span><span class="p">(</span><span class="mi">92</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">93</span><span class="p">)</span><span class="w">   </span><span class="c1">//      below for details</span>

<span class="n">ROUTE</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;Coal Yard exit&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">RED</span><span class="p">(</span><span class="mi">77</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">THROW</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">CLOSE</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">DELAY</span><span class="p">(</span><span class="mi">5000</span><span class="p">)</span><span class="w">  </span><span class="c1">// this is a 5 second wait</span>
<span class="w">   </span><span class="n">GREEN</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">DONE</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="example-2-automating-signals-with-turnouts">
<h3>Example 2: Automating Signals with Turnouts<a class="headerlink" href="#example-2-automating-signals-with-turnouts" title="Permalink to this headline">¶</a></h3>
<p>By intercepting a turnout change command, it’s easy to automatically adjust signals or
automatically switch an adjacent facing turnout. Use an <code class="docutils literal notranslate"><span class="pre">ONTHROW</span></code> or <code class="docutils literal notranslate"><span class="pre">ONCLOSE</span></code> keyword to detect a particular turnout change:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">ONTHROW</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">  </span><span class="c1">// When turnout 8 is thrown,</span>
<span class="w">   </span><span class="n">THROW</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="w">  </span><span class="c1">// must also throw the facing turnout</span>
<span class="w">   </span><span class="n">RED</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">DELAY</span><span class="p">(</span><span class="mi">2000</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">GREEN</span><span class="p">(</span><span class="mi">27</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">DONE</span><span class="w"></span>

<span class="n">ONCLOSE</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">  </span><span class="c1">// When turnout 8 is closed</span>
<span class="w">  </span><span class="n">CLOSE</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">RED</span><span class="p">(</span><span class="mi">27</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">DELAY</span><span class="p">(</span><span class="mi">2000</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">GREEN</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">DONE</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="defining-turnouts">
<h2>Defining Turnouts<a class="headerlink" href="#defining-turnouts" title="Permalink to this headline">¶</a></h2>
<p>DCC-EX supports a number of different turnout hardware configurations, but your automation treats them all as simple ID numbers. Turnouts may be defined using <code class="docutils literal notranslate"><span class="pre">&lt;T&gt;</span></code> commands from JMRI, or in <code class="docutils literal notranslate"><span class="pre">SETUP(&quot;&lt;T</span> <span class="pre">...&gt;&quot;)</span></code> commands or C++ code in mySetup.h, just like earlier versions.</p>
<p>You may, however, find it more convenient to define turnouts using EX-RAIL commands, which may appear anywhere in the ‘myAutomation.h’ file, even after they are referenced in an <code class="docutils literal notranslate"><span class="pre">ONTHROW</span></code>, <code class="docutils literal notranslate"><span class="pre">ONCLOSE</span></code>, <code class="docutils literal notranslate"><span class="pre">THROW</span></code> or <code class="docutils literal notranslate"><span class="pre">CLOSE</span></code> command. (EXRAIL extracts the turnout definitions just once from your script at Command Station startup.)</p>
<p>Turnouts defined in ‘myAutomation.h’ will still be visible to WiThrottle and JMRI in the normal way.</p>
<p>See the <a class="reference internal" href="EX-RAIL-ref.html#ex-rail-reference"><span class="std std-ref">Reference</span></a> section for TURNOUT, PIN_TURNOUT and SERVO_TURNOUT definitions.</p>
</div>
<div class="section" id="defining-signals">
<h2>Defining Signals<a class="headerlink" href="#defining-signals" title="Permalink to this headline">¶</a></h2>
<p>Signals can now simply be a decoration to be switched by the route process; they don’t need to control anything.</p>
<p><code class="docutils literal notranslate"><span class="pre">GREEN(55)</span></code> would turn signal 55 green, and <code class="docutils literal notranslate"><span class="pre">RED(55)</span></code> would turn it red. Somewhere in the script there must be a SIGNAL command like this: <code class="docutils literal notranslate"><span class="pre">SIGNAL(55,56,57)</span></code>.  This defines a signal with ID 55, where the Red/Stop lamp is connected to pin 55, the Amber/Caution lamp to pin 56, and the Green/Proceed lamp to pin 57. The pin allocations do not need to be contiguous, and the red pin number is also used as the signal ID. Thus you can change the signal by <code class="docutils literal notranslate"><span class="pre">RED(55)</span></code>, <code class="docutils literal notranslate"><span class="pre">AMBER(55)</span></code>, or <code class="docutils literal notranslate"><span class="pre">GREEN(55)</span></code>. This means you don’t have to manually turn off the other lamps. A RED/GREEN only signal may be created with a zero amber pin.</p>
<div class="section" id="example-3-automating-various-non-track-items">
<h3>Example 3: Automating various non-track items<a class="headerlink" href="#example-3-automating-various-non-track-items" title="Permalink to this headline">¶</a></h3>
<p>This normally takes place in a timed loop, for example alternate flashing of a fire engine’s lights. To do this use a SEQUENCE.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">SEQUENCE</span><span class="p">(</span><span class="mi">66</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">SET</span><span class="p">(</span><span class="mi">101</span><span class="p">)</span><span class="w">   </span><span class="c1">// sets output 101 HIGH</span>
<span class="w">  </span><span class="n">RESET</span><span class="p">(</span><span class="mi">102</span><span class="p">)</span><span class="w"> </span><span class="c1">// sets output 102 LOW</span>
<span class="w">  </span><span class="n">DELAY</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="w">   </span><span class="c1">// wait 0.5 seconds</span>
<span class="w">  </span><span class="n">SET</span><span class="p">(</span><span class="mi">102</span><span class="p">)</span><span class="w">   </span><span class="c1">// swap the lights</span>
<span class="w">  </span><span class="n">RESET</span><span class="p">(</span><span class="mi">101</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">DELAY</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="w">   </span><span class="c1">// wait 0.5 seconds</span>
<span class="w">  </span><span class="n">FOLLOW</span><span class="p">(</span><span class="mi">66</span><span class="p">)</span><span class="w">  </span><span class="c1">// follow sequence 66 continuously</span>
</pre></div>
</div>
<p>Note, however, that this sequence will not start automatically: it must be started during the startup process (see later) using <code class="docutils literal notranslate"><span class="pre">START(66)</span></code>.</p>
</div>
<div class="section" id="example-4-automating-a-train-simple-loop">
<h3>Example 4: Automating a train (simple loop)<a class="headerlink" href="#example-4-automating-a-train-simple-loop" title="Permalink to this headline">¶</a></h3>
<p>Start with something as simple as a single loop of track with a station and a sensor (connected to pin 40 for this example) at the point where you want the train to stop.</p>
<a class="reference internal image-reference" href="../_images/Example_4_diagram.png"><img alt="Simple example 4" class="align-center" src="../_images/Example_4_diagram.png" style="width: 915.0px; height: 191.0px;" /></a>
<p>Using an <code class="docutils literal notranslate"><span class="pre">AUTOMATION</span></code> keyword means that this automation will appear in EngineDriver so you can drive the train manually, and then hand it over to the automation at the press of a button.</p>
<p>* Technically, an automation can independently run multiple locos along the same path through the layout, but this is discussed later…</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">AUTOMATION</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="s">&quot;Round in circles&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">FWD</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w">   </span><span class="c1">// move forward at DCC speed 50 (out of 127)</span>
<span class="w">   </span><span class="n">AT</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span><span class="w">     </span><span class="c1">// when you get to sensor on pin (40)</span>
<span class="w">   </span><span class="n">STOP</span><span class="w">      </span><span class="c1">// stop the train</span>
<span class="w">   </span><span class="n">DELAYRANDOM</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span><span class="mi">20000</span><span class="p">)</span><span class="w"> </span><span class="c1">// delay somewhere between 5 and 20 seconds</span>
<span class="w">   </span><span class="n">FWD</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="w">   </span><span class="c1">// start a bit slower</span>
<span class="w">   </span><span class="n">AFTER</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span><span class="w">  </span><span class="c1">// until sensor on pin 40 has been passed</span>
<span class="w">   </span><span class="n">FOLLOW</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="c1">// and continue to follow the automation</span>
</pre></div>
</div>
<p>The instructions are followed in sequence by the loco given to it; the <code class="docutils literal notranslate"><span class="pre">AT</span></code> command just leaves the loco running until that sensor is detected.</p>
<p>Notice that this automation does not specify the loco address. If you drive a loco with EngineDriver and then hand it over to this automation, then the automation will run with the loco you last drove.</p>
</div>
<div class="section" id="example-5-signals-in-a-train-script">
<h3>Example 5: Signals in a train script<a class="headerlink" href="#example-5-signals-in-a-train-script" title="Permalink to this headline">¶</a></h3>
<p>Adding a station signal to the loop script is extremely simple, but it does require a mind-shift for some modellers who like to think in terms of signals being in control of trains! EX-RAIL takes a different approach, by animating the signals as part of the driving script. Thus set a signal GREEN before moving off (and allow a little delay for the driver to react) and RED after you have passed it.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">SIGNAL</span><span class="p">(</span><span class="mi">77</span><span class="p">,</span><span class="mi">78</span><span class="p">,</span><span class="mi">79</span><span class="p">)</span><span class="w">  </span><span class="c1">// see the Defining Signals section above for details</span>
<span class="n">AUTOMATION</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="s">&quot;Round in circles&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">FWD</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w">   </span><span class="c1">// move forward at DCC speed 50 (out of 127)</span>
<span class="w">   </span><span class="n">AT</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span><span class="w">    </span><span class="c1">// when you get to sensor on pin (40)</span>
<span class="w">   </span><span class="n">STOP</span><span class="w">      </span><span class="c1">// Stop the train</span>
<span class="w">   </span><span class="n">DELAYRANDOM</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span><span class="mi">20000</span><span class="p">)</span><span class="w"> </span><span class="c1">// delay somewhere between 5 and 20 seconds</span>
<span class="w">   </span><span class="n">GREEN</span><span class="p">(</span><span class="mi">77</span><span class="p">)</span><span class="w">    </span><span class="c1">// set signal #77 to Green</span>
<span class="w">   </span><span class="n">DELAY</span><span class="p">(</span><span class="mi">2500</span><span class="p">)</span><span class="w">  </span><span class="c1">// This is not Formula1!</span>
<span class="w">   </span><span class="n">FWD</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="w">    </span><span class="c1">// start a bit slower</span>
<span class="w">   </span><span class="n">AFTER</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span><span class="w">  </span><span class="c1">// until sensor on pin 40 has been passed</span>
<span class="w">   </span><span class="n">RED</span><span class="p">(</span><span class="mi">77</span><span class="p">)</span><span class="w">    </span><span class="c1">// set signal #77 to Red</span>
<span class="w">   </span><span class="n">FOLLOW</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w">  </span><span class="c1">// and continue to follow the automation</span>
</pre></div>
</div>
</div>
<div class="section" id="example-6-single-line-shuttle">
<h3>Example 6: Single line shuttle<a class="headerlink" href="#example-6-single-line-shuttle" title="Permalink to this headline">¶</a></h3>
<p>Consider a single line, shuttling between stations A and B.</p>
<a class="reference internal image-reference" href="../_images/Example_6_diagram.png"><img alt="Simple example 4" class="align-center" src="../_images/Example_6_diagram.png" style="width: 944.0px; height: 188.0px;" /></a>
<p>Starting from Station A, the steps may be something like:</p>
<ul class="simple">
<li><p>Wait between 10 and 20 seconds for the guard to stop chatting up the girl in the ticket office.</p></li>
<li><p>Move forward at speed 30</p></li>
<li><p>When I get to B, stop.</p></li>
<li><p>Wait 15 seconds for the tea trolley to be restocked</p></li>
<li><p>Move backwards at speed 20</p></li>
<li><p>When I get to A, stop.</p></li>
</ul>
<p>Notice that the sensors at A and B are near the ends of the track (allowing for braking distance, but don’t care about train length or whether the engine is at the front or back.) We have wired sensor A on pin 41, and sensor B on pin 42 for this example.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">SEQUENCE</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">DELAYRANDOM</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span><span class="mi">20000</span><span class="p">)</span><span class="w"> </span><span class="c1">// random wait between 10 and 20 seconds</span>
<span class="w">  </span><span class="n">FWD</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">AT</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span><span class="w"> </span><span class="c1">// sensor 42 is at the far end of platform B</span>
<span class="w">  </span><span class="n">STOP</span><span class="w"></span>
<span class="w">  </span><span class="n">DELAY</span><span class="p">(</span><span class="mi">15000</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">REV</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="c1">// Reverse at DCC speed 20 (out of 127)</span>
<span class="w">  </span><span class="n">AT</span><span class="p">(</span><span class="mi">41</span><span class="p">)</span><span class="w"> </span><span class="c1">// far end of platform A</span>
<span class="w">  </span><span class="n">STOP</span><span class="w"></span>
<span class="w">  </span><span class="n">FOLLOW</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span><span class="w"> </span><span class="c1">// follows sequence 13 again… forever</span>
</pre></div>
</div>
<p>Note a SEQUENCE is exactly the same as an AUTOMATION except that it does NOT appear in the EngineDriver app.</p>
<p>When the Command Station is powered up or reset, EX-RAIL starts operating at the beginning of the file.  For this sequence we need to set a loco address and start the sequence:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">SETLOCO</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"></span>
<span class="n">START</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span><span class="w"></span>
<span class="n">DONE</span><span class="w">        </span><span class="c1">// This marks the end of the startup process</span>
</pre></div>
</div>
<p>The sequence can also be started from a serial monitor with the command <code class="docutils literal notranslate"><span class="pre">&lt;/</span> <span class="pre">START</span> <span class="pre">3</span> <span class="pre">13&gt;</span></code>.</p>
<p>If you have multiple separate sections of track which do not require inter-train cooperation, you may add many more separate sequences and they will operate independently.</p>
<p>Although the above is trivial, the routes are designed to be independent of the loco address so that we can have several locos following the same route at the same time (not in the end to end example above!), perhaps passing each other or crossing over with trains on other routes.</p>
<p>The example above assumes that loco 3 is sitting on the track and pointing in the right direction. A bit later you will see how to script an automatic process to take whatever loco is placed on the programming track, and send it on its way to join in the fun!</p>
</div>
<div class="section" id="example-7-running-multiple-inter-connected-trains">
<h3>Example 7: Running multiple inter-connected trains<a class="headerlink" href="#example-7-running-multiple-inter-connected-trains" title="Permalink to this headline">¶</a></h3>
<p>So what about routes that cross or share single lines (passing places etc)?
Let’s add a passing place between A and B. S= Sensors, T=Turnout
number. So now our route looks like this:</p>
<a class="reference internal image-reference" href="../_images/Example_7a_diagram.png"><img alt="Simple example 4" class="align-center" src="../_images/Example_7a_diagram.png" style="width: 944.0px; height: 188.0px;" /></a>
<p>Assuming that you have defined your turnouts with <a class="reference internal" href="EX-RAIL-ref.html#routes-automations-sequences"><span class="std std-ref">TURNOUT commands.</span></a></p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">SEQUENCE</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">DELAYRANDOM</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span><span class="mi">20000</span><span class="p">)</span><span class="w"> </span><span class="c1">// random wait between 10 and 20 seconds</span>
<span class="w">   </span><span class="n">CLOSE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">CLOSE</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">FWD</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">AT</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span><span class="w"> </span><span class="c1">// sensor 42 is at the far end of platform B</span>
<span class="w">   </span><span class="n">STOP</span><span class="w"></span>
<span class="w">   </span><span class="n">DELAY</span><span class="p">(</span><span class="mi">15000</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">THROW</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">THROW</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">REV</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">AT</span><span class="p">(</span><span class="mi">41</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">STOP</span><span class="w"></span>
<span class="w">   </span><span class="n">FOLLOW</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="c1">// follows sequence 11 again… forever</span>
</pre></div>
</div>
<p>All well and good for one loco, but with 2 (or even 3) on this track we need some rules. The principle behind this is</p>
<ul class="simple">
<li><p>To enter a section of track that may be shared, you must RESERVE it. If you cant reserve it because another loco already has, then you will be stopped and the script will wait until such time as you can reserve it. When you leave a shared section you must free it.</p></li>
<li><p>Each “section” is merely a logical concept, there are no electronic section breaks in the track. You may have up to 255 sections (more can be supported by a code mod if required).</p></li>
</ul>
<p>So we will need some extra sensors (hardware required) and some logical blocks (all in the mind!):</p>
<a class="reference internal image-reference" href="../_images/Example_7b_diagram.png"><img alt="Simple example 4" class="align-center" src="../_images/Example_7b_diagram.png" style="width: 944.0px; height: 188.0px;" /></a>
<p>We can use this diagram to plan routes. When we do so, it will be easier to imagine 4 separate mini routes, each passing from one block to the next. Then we can chain them together to form a full route, but also start from any block.</p>
<p>So… lets take a look at the routes now. For convenience I have used route numbers that help remind us what the route is for.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">SEQUENCE</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="c1">// From block 1 to block 2</span>
<span class="w">   </span><span class="n">DELAYRANDOM</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span><span class="mi">20000</span><span class="p">)</span><span class="w"> </span><span class="c1">// random wait between 10 and 20 seconds</span>
<span class="w">   </span><span class="n">RESERVE</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="c1">// we wish to enter block 2… so wait for it</span>
<span class="w">   </span><span class="n">CLOSE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c1">// Now we “own” the block, set the turnout</span>
<span class="w">   </span><span class="n">FWD</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="w"> </span><span class="c1">// and proceed forward</span>
<span class="w">   </span><span class="n">AFTER</span><span class="p">(</span><span class="mi">71</span><span class="p">)</span><span class="w"> </span><span class="c1">// Once we have reached AND passed sensor 71</span>
<span class="w">   </span><span class="n">FREE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c1">// we no longer occupy block 1</span>
<span class="w">   </span><span class="n">AT</span><span class="p">(</span><span class="mi">72</span><span class="p">)</span><span class="w"> </span><span class="c1">// When we get to sensor 72</span>
<span class="w">   </span><span class="n">FOLLOW</span><span class="p">(</span><span class="mi">23</span><span class="p">)</span><span class="w"> </span><span class="c1">// follow route from block 2 to block 3</span>

<span class="n">SEQUENCE</span><span class="p">(</span><span class="mi">23</span><span class="p">)</span><span class="w"> </span><span class="c1">// Travel from block 2 to block 3</span>
<span class="w">   </span><span class="n">RESERVE</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="c1">// will STOP if block 3 occupied</span>
<span class="w">   </span><span class="n">CLOSE</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="c1">// Now we have the block, we can set turnouts</span>
<span class="w">   </span><span class="n">FWD</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="c1">// we may or may not have stopped at the RESERVE</span>
<span class="w">   </span><span class="n">AT</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span><span class="w"> </span><span class="c1">// sensor 2 is at the far end of platform B</span>
<span class="w">   </span><span class="n">STOP</span><span class="w"></span>
<span class="w">   </span><span class="n">FREE</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">DELAY</span><span class="p">(</span><span class="mi">15000</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">FOLLOW</span><span class="p">(</span><span class="mi">34</span><span class="p">)</span><span class="w"></span>

<span class="n">SEQUENCE</span><span class="p">(</span><span class="mi">34</span><span class="p">)</span><span class="w"> </span><span class="c1">// you get the idea</span>
<span class="w">   </span><span class="n">RESERVE</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">THROW</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">REV</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">AFTER</span><span class="p">(</span><span class="mi">73</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">FREE</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">AT</span><span class="p">(</span><span class="mi">74</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">FOLLOW</span><span class="p">(</span><span class="mi">41</span><span class="p">)</span><span class="w"></span>

<span class="n">SEQUENCE</span><span class="p">(</span><span class="mi">41</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">RESERVE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">THROW</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">REV</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">AT</span><span class="p">(</span><span class="mi">41</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">STOP</span><span class="w"></span>
<span class="w">   </span><span class="n">FREE</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">FOLLOW</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="c1">// follows Route 12 again… forever</span>
</pre></div>
</div>
<p>Does that look long? Worried about memory on your Arduino…. Well the script above takes about 100 BYTES of program memory and no dynamic SRAM!</p>
<p>If you follow this example carefully, you’ll see it allows for up to 3 trains at a time, because one of them will always have somewhere to go. Notice that there is a common theme to this…</p>
<ul class="simple">
<li><p>RESERVE where you want to go. If you are moving and the reserve fails, your loco will STOP and the reserve waits for the block to become available. *These waits and the manual WAITS do not block the Arduino process… DCC and the other locos continue to follow their routes!</p></li>
<li><p>Set the points to enter the reserved area. Do this ASAP, as you may be still moving towards them.</p></li>
<li><p>Set any signals.</p></li>
<li><p>Move into the reserved area.</p></li>
<li><p>Reset your signals.</p></li>
<li><p>Free off your previous reserve as soon as you have fully left the block.</p></li>
</ul>
<p>In addition, it is possible to take decisions based on blocks reserved by other trains. The IFRESERVE(block) can be used to reserve a block if it’s not already reserved by some other train, or skip to the matching ENDIF. For example, this allows a train to choose which platform to stop at based on prior occupancy. It is features like this that allow for more interesting and unpredictable automations.</p>
</div>
</div>
<div class="section" id="starting-the-system">
<h2>Starting the system<a class="headerlink" href="#starting-the-system" title="Permalink to this headline">¶</a></h2>
<p>Starting the system is tricky, because we need to place the trains in a suitable position and set them going. We need to have a starting position for each loco, and reserve the block(s) it needs to keep other trains from crashing into it.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This EX-RAIL version isn’t ready to handle locos randomly placed on the layout after a power down!</p>
</div>
<p>For a known set of locos, the easiest way is to define the startup process at the beginning of ROUTES. E.g. for two engines, one at each station.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// ensure all blocks are reserved as if the locos had arrived there</span>
<span class="n">RESERVE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c1">// start with a loco in block 1</span>
<span class="n">RESERVE</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="c1">// and another in block 3</span>
<span class="n">SENDLOCO</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="c1">// send Loco DCC addr 3 on to route 12</span>
<span class="n">SENDLOCO</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span><span class="mi">34</span><span class="p">)</span><span class="w"> </span><span class="c1">// send loco DCC addr 17 to route 34</span>
<span class="n">DONE</span><span class="w"> </span><span class="c1">// don’t drop through to the first route definition that follows in the script file</span>
</pre></div>
</div>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Some interesting points about the startup:</p>
<ul class="simple">
<li><p>You don’t need to set turnouts, because each route is setting them as required.</p></li>
<li><p>Signals default to RED on power up, and get turned GREEN when a route clears them.</p></li>
</ul>
</div>
</div>
<div class="section" id="drive-away-feature">
<h2>Drive Away feature<a class="headerlink" href="#drive-away-feature" title="Permalink to this headline">¶</a></h2>
<p>EX-RAIL can switch a track section between programming and mainline automatically.</p>
<p>Here for example is a startup route that has no predefined locos but allows locos to be added at station 1 while the system is in motion. Let’s assume that the track section at Station1 is isolated and connected to the programming track power supply. Also that we have a “launch” button connected where sensor 17 would be and an optional signal (ie 3 leds) on the control panel connected where signal 27 would be.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">SEQUENCE</span><span class="p">(</span><span class="mi">99</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">SIGNAL</span><span class="p">(</span><span class="mi">27</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">29</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">RED</span><span class="p">(</span><span class="mi">27</span><span class="p">)</span><span class="w">   </span><span class="c1">// indicate launch not ready</span>
<span class="w">  </span><span class="n">AFTER</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span><span class="w"> </span><span class="c1">// user presses and releases launch button</span>
<span class="w">  </span><span class="n">UNJOIN</span><span class="w">    </span><span class="c1">// separate the programming track from main</span>
<span class="w">  </span><span class="n">DELAY</span><span class="p">(</span><span class="mi">2000</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">AMBER</span><span class="p">(</span><span class="mi">27</span><span class="p">)</span><span class="w"> </span><span class="c1">// Show amber, user may place loco</span>
<span class="w">  </span><span class="n">AFTER</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span><span class="w"> </span><span class="c1">// user places loco on track and presses “launch” again</span>
<span class="w">  </span><span class="n">READ_LOCO</span><span class="w"> </span><span class="c1">// identify the loco</span>
<span class="w">  </span><span class="n">GREEN</span><span class="p">(</span><span class="mi">27</span><span class="p">)</span><span class="w"> </span><span class="c1">// show green light to user</span>
<span class="w">  </span><span class="n">JOIN</span><span class="w">      </span><span class="c1">// connect prog track to main</span>
<span class="w">  </span><span class="n">START</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="c1">// send loco off along route 12</span>
<span class="w">  </span><span class="n">FOLLOW</span><span class="p">(</span><span class="mi">99</span><span class="p">)</span><span class="w"> </span><span class="c1">// keep doing this for another launch</span>
</pre></div>
</div>
<p>The READ_LOCO reads the loco address from the PROG track and the current route takes on that loco. By altering the script slightly and adding another sensor, it’s possible to detect which way the loco sets off and switch the code logic to send it in the correct direction by using the INVERT_DIRECTION instruction so that this locos FWD and REV commands are reversed. (easily done with diesels!)</p>
</div>
<div class="section" id="sounds">
<h2>Sounds<a class="headerlink" href="#sounds" title="Permalink to this headline">¶</a></h2>
<p>You can use <code class="docutils literal notranslate"><span class="pre">FON(n)</span></code> and <code class="docutils literal notranslate"><span class="pre">FOFF(n)</span></code> to switch loco functions… eg sound horn.</p>
</div>
<div class="section" id="sensors">
<h2>Sensors<a class="headerlink" href="#sensors" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>DCC++EX allows for sensors that are <strong>Active Low or Active High</strong>. This is particularly important for IR sensors that have been converted to detect by broken beam, rather than reflection. By making the sensor number negative, the sensor state is inverted. e.g. <code class="docutils literal notranslate"><span class="pre">AT(-5)</span></code>.</p></li>
<li><p>Magnetic/Hall effect sensors work for some layouts, but beware of how you detect the back end of a train approaching the buffers in a siding, or knowing when the last car has cleared a crossing.</p></li>
<li><p>Handling sensors in the automation is made easy because EX-RAIL throws away the concept of interrupts (“oh… sensor 5 has been detected… which loco was that and whatever do I do now?”) and instead has the route scripts work on the basis of “do nothing, maintain speed until sensor 5 triggers, and then carry on in the script”.</p></li>
<li><p>Sensor numbers are direct references to VPINs (virtual pin numbers) in the Hardware Abstraction Layer. For a Mega onboard GPIO pin, this is the same as the digital pin number. Other pin ranges refer to I/O expanders etc.</p></li>
<li><p>Sensors with ID’s 0 to 255 may be LATCHED/UNLATCHED in your script. If a sensor is latched on by the script, it can only be set off by the script… so <code class="docutils literal notranslate"><span class="pre">AT(5)</span> <span class="pre">LATCH(5)</span></code> for example effectively latches the sensor 5 on when detected once.</p></li>
<li><p>Sensor polling by JMRI is independent of this, and may continue if &lt;S&gt; commands are used.</p></li>
</ul>
</div>
<div class="section" id="outputs">
<h2>Outputs<a class="headerlink" href="#outputs" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Generic Outputs are mapped to VPINs on the HAL (as for sensors)</p></li>
<li><p>SIGNAL definitions are just groups of 3 Output pins that can be more easily managed.</p></li>
</ul>
</div>
<div class="section" id="sequence-numbers">
<h2>Sequence Numbers<a class="headerlink" href="#sequence-numbers" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>All ROUTE / AUTOMATION / SEQUENCE  ids are limited to 1- 32767</p></li>
<li><p>0 is reserved for the startup sequence appearing as the first entry in the EXRAIL script.</p></li>
</ul>
</div>
<div class="section" id="various-techniques">
<h2>Various techniques<a class="headerlink" href="#various-techniques" title="Permalink to this headline">¶</a></h2>
<div class="section" id="defining-names-for-any-id-numbers">
<h3>Defining names for any ID numbers<a class="headerlink" href="#defining-names-for-any-id-numbers" title="Permalink to this headline">¶</a></h3>
<p>Use the <code class="docutils literal notranslate"><span class="pre">ALIAS()</span></code> command in your script file. This must come <em>BEFORE</em> the <code class="docutils literal notranslate"><span class="pre">EXRAIL</span></code> command.</p>
<p>Alias names:</p>
<ul>
<li><p><strong>Should be</strong> reasonably short but descriptive.</p></li>
<li><p><strong>Must start</strong> with letters A-Z or underscore _ .</p></li>
<li><p><strong>May then</strong> also contain numbers.</p></li>
<li><p><strong>Must not</strong> contain spaces or special characters.</p>
<p>For example:</p>
</li>
</ul>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">ALIAS</span><span class="p">(</span><span class="n">COAL_YARD_TURNOUT</span><span class="p">,</span><span class="mi">19</span><span class="p">)</span><span class="w"></span>
<span class="n">ALIAS</span><span class="p">(</span><span class="n">COAL_YARD_SIGNAL_3</span><span class="p">,</span><span class="mi">27</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">EXRAIL</span><span class="w"></span>
<span class="w">      </span><span class="n">ROUTE</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;Coal yard exit&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="n">THROW</span><span class="p">(</span><span class="n">COAL_YARD_TURNOUT</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="n">GREEN</span><span class="p">(</span><span class="n">COAL_YARD_SIGNAL_3</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<ul>
<li><p>Including sub-files</p>
<p>For example:</p>
</li>
</ul>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">EXRAIL</span><span class="w"></span>
<span class="w">   </span><span class="n">ROUTE</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;Coal yard exit&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">THROW</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">GREEN</span><span class="p">(</span><span class="mi">27</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">DONE</span><span class="w"></span>
<span class="w">   </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;myFireEngineLights.h&quot;</span><span class="cp"></span>
<span class="w">   </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;myShuttle.h&quot;</span><span class="cp"></span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="EX-RAIL-ref.html" class="btn btn-neutral float-right" title="EX-RAIL Reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="index.html" class="btn btn-neutral float-left" title="Automation (EX-RAIL) BETA!" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, 2021 - Fred Decker, Mani Kumar.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>